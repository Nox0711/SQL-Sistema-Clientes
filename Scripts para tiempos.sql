-- 1. Parámetros para cálculo de tiempos
	--nombre de la tabla= PROC_TIEMPOSET(a,b,c)
		-- a es 'at' o 'ing' dependiendo del área a la cual se le quiere calcular tiempos
		-- b es el mes para cálculo del indicador (numero del 1 al 12)
		-- c es el año para cálculo del indicador (año en formato aaaa es decir 2024, etc)

	--Tiempos AT
	SELECT 	*
	FROM PROC_TIEMPOSET('at',:MES,:ANIO) 

	--Tiempos Ing
	SELECT *
	FROM PROC_TIEMPOSET('ing',:MES,:ANIO)
	
	--Tiempos QA DIS
	SELECT *
	FROM PROC_TIEMPOSET('QADIS',:MES,:ANIO)
	
	-- Tiempos QA SOP AT
	SELECT *
	FROM PROC_TIEMPOSET('QASOPAT',:MES,:ANIO)
	
	
	SELECT FIRST 1 'hola mundo :D'
	FROM SOP_TIQUETES
	
--Para buscar los tiquetes por itiquete REF
	SELECT ITIQUETE, ITIQUETEREF 
	FROM SOP_TIQUETES
	--LEFT JOIN SOP_P
	WHERE itiquete IN ('1244472','1244162','1243360')
	
--Todos los tiquetes de ATE relacionando la tabla SOP_TIQUETES y CONSULTADCEBALLOS
	SELECT T2.*, T1.QDEDICACION 
	FROM CONSULTADCEBALLOS T2
	LEFT JOIN SOP_TIQUETES T1 ON T1.ITIQUETE=T2.ITIQUETE 
	WHERE T2.FECHAAPERTURA > '2023-12-31'
	AND T2.ASIGNADOA IN ('SALARCON', 'ACESPEDES', 'ATORO', 'AGIL', 'TLEON', 'VRESTREPO')
	
--La tabla SOP_BITACORATIQUETE muestra la información de la bitácora de los tiquetes (apertura, reasiganción, cierre)
	SELECT T1.*, T2.ASIGNADOA
	FROM SOP_TIQUETES T2
	LEFT JOIN SOP_BITACORATIQUETE T1 ON T1.ITIQUETE=T2.ITIQUETE 
	WHERE T2.ITEMA = 'AT-APO10'
	AND T2.FHAPERTURA > '2023-01-01'
	AND T1.NACCION = 'REASIGNACION'
	ORDER BY T1.FHBITACORA DESC 
	
--Query para consultar el estado de las mejoras
	SELECT
		T1.ITIQUETE,
		T3.NTEMA AS tema,
		T1.ASIGNADOA AS gestiona,
		T1.FHAPERTURA,
		T1.FHATENDIDO,
		T1.FHSOLUCIONADO,
		T1.FHCIERRE,
		T5.NTITULO AS TIPO_SOLICITUD_APERTURA,
		T7.NTITULO AS ESTADODESOLICITUD,
		CASE
			WHEN T1.FHCIERRE >= DATEADD(MONTH,-3,CURRENT_DATE) THEN 'Cerrado hace más de 3 meses'
			WHEN T1.FHCIERRE IS NOT NULL THEN 'Cerrado'
			WHEN T1.FHATENDIDO IS NULL THEN 'Sin atender'
			WHEN T1.FHSOLUCIONADO IS NULL AND T1.BPQR = 'T' THEN 'Escalado a ING - Sin solucionar'
			WHEN T1.FHSOLUCIONADO IS NULL THEN 'Sin solucionar'
		END AS ESTADO
		FROM SOP_TIQUETES T1
		LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA
		LEFT JOIN ABADTIT T5 ON T5.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T5.ITITULO --tipo solicitud de apertura
		LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA = T7.ITITULO
		WHERE 
		T1.BANULADO='F' 
		AND T5.NTITULO IN ('1 - PQR mejora','A - PQR adición o mejora') 
		AND T1.ASIGNADOA IN('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON')
		--AND T1.ITIQUETE IN ('1202998','1205006')
		--AND T1.FHAPERTURA >'2024-01-01' 
		ORDER BY T1.ASIGNADOA ASC
		
--Query para consultar el estado de las mejoras (Revisar tiempos)
	SELECT
		T1.ITIQUETE,
		T3.NTEMA AS tema,
		T1.ASIGNADOA AS gestiona,
		T1.FHAPERTURA,
		T1.FHATENDIDO,
		T1.FHSOLUCIONADO,
		T1.FHCIERRE,
		T5.NTITULO AS TIPO_SOLICITUD_APERTURA,
		T7.NTITULO AS ESTADODESOLICITUD,
		CASE
			WHEN T1.FHCIERRE >= DATEADD(MONTH,-3,CURRENT_DATE) THEN 'Cerrado hace más de 3 meses'
			WHEN T1.FHCIERRE IS NOT NULL THEN 'Cerrado'
			WHEN T1.FHATENDIDO IS NULL THEN 'Sin atender'
			WHEN T1.FHSOLUCIONADO IS NULL AND T1.BPQR = 'T' THEN 'Escalado a ING - Sin solucionar'
			WHEN T1.FHSOLUCIONADO IS NULL THEN 'Sin solucionar'
		END AS ESTADO,
		(T1.QMINATENCIONEMPRESA/60.00) AS TA,
		(T1.QMINSOLUCIONEMPRESA/60.00) AS TS,
		(T1.QMINCIERREEMPRESA/60.00) AS TC
		FROM SOP_TIQUETES T1
		LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA
		LEFT JOIN ABADTIT T5 ON T5.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T5.ITITULO --tipo solicitud de apertura
		LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA = T7.ITITULO
		WHERE 
		T1.BANULADO='F'
	    --AND EXTRACT(MONTH FROM T1.FHCIERRE) = :MES
        --AND EXTRACT(YEAR FROM T1.FHCIERRE) = :ANIO
		AND EXTRACT(MONTH FROM T1.FHAPERTURA) = :MES
        AND EXTRACT(YEAR FROM T1.FHAPERTURA) = :ANIO
		AND T5.NTITULO IN ('1 - PQR mejora','A - PQR adición o mejora') 
		AND T1.ASIGNADOA IN('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON')
		--AND T1.ITIQUETE IN ('1202998','1205006')
		ORDER BY T1.ASIGNADOA ASC


--Query para revisar la dedicación de atención de tiquetes en el mes de diciembre
SELECT ITIQUETE, NCATEGORIA, NTEMA, FECHAAPERTURA, FECHASOLUCION, SEMANAAPERTURA, QDEDICACION_HORAS 
FROM CONSULTADCEBALLOS
WHERE ASIGNADOA IN ('SALARCON')
AND FECHAAPERTURA >='2024-11-01'

--Query para gestionar los tks que llegan a ATE y no estén solucionados. (Esta lista incluye los tks anulados)
SELECT T1.ITIQUETE,T3.NTEMA,T1.ASIGNADOA,T1.BATENDIDO,T5.NTITULO AS TipoSolicitudApertura,T6.NTITULO AS TipoSolicitudCierre, --DATEDIFF(DAY,FECHA,FECHASOLUCION) AS DIAS
FROM SOP_TIQUETES T1
LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA
LEFT JOIN ABADTIT T5 ON T5.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T5.ITITULO
LEFT JOIN ABADTIT T6 ON T6.ITABLA='ITDSOLICITUDC' AND T1.ITDSOLICITUD=T6.ITITULO
WHERE T1.FHAPERTURA>'2023-12-31'
AND T1.ASIGNADOA IN ('SALARCON', 'ACESPEDES', 'ATORO', 'AGIL', 'TLEON', 'VRESTREPO','LGIRALDO')
--AND T1.ASIGNADOA IN ('ACESPEDES') --Esta línea la uso cuando necesito ver de un especialista en particular.
AND T3.NTEMA LIKE '%Sop AT -%'
AND T1.BSOLUCIONADO<>'T'
AND T5.NTITULO NOT IN ('1 - PQR mejora')
AND COALESCE(T6.NTITULO,0) NOT IN ('1 - PQR - Adición o mejora aprobada')
ORDER BY T1.ASIGNADOA

--Query para alimentar BD del resumen 2024 ATE de Power BI
SELECT T2.*,T1.BEXCLUIRINFORMES, T1.FHSOLUCIONADO, T1.FHCIERRE 
FROM CONSULTADCEBALLOS T2
LEFT JOIN SOP_TIQUETES T1 ON T1.ITIQUETE = T2.ITIQUETE
WHERE --T2.FECHACIERRE BETWEEN '2024-01-01' AND '2024-12-31'
T2.ASIGNADOA IN ('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON')

--Query para asignar el clasificador a los tiquetes de pruebas
SELECT ITIQUETE, NTEMA 
FROM CONSULTADCEBALLOS
WHERE ITIQUETE IN ('1293985','1294218','1293912','1294252')




--Query para extraer el primer mensaje de los tiquetes para IA VRESTREPO
		WITH X1 AS(
	SELECT RANK() OVER (PARTITION BY T1.ITIQUETE ORDER BY T1.FHMENSAJE ASC) AS RANGO,T1.ITIQUETE, T1.MENSAJE,T2.FHAPERTURA,T2.ASIGNADOA, T1.REMITENTE, T3.NTEMA
	FROM SOP_MENSAJES T1
	LEFT JOIN SOP_TIQUETES T2 ON T1.ITIQUETE=T2.ITIQUETE
	LEFT JOIN SOP_TEMAS T3 ON T2.ITEMA=T3.ITEMA
	WHERE T2.FHAPERTURA > '2025-03-01'
	AND T1.REMITENTE IS DISTINCT FROM T2.ASIGNADOA
	AND T3.ITEMA IN ('MED')
	)
	SELECT *
	FROM X1
	WHERE RANGO=1
	

SELECT *
FROM SOP_MENSAJES 
WHERE ITIQUETE IN ('1252861','1251079','1250500','1250499','1250498','1250497','1246783','1239761','1239760','1239754','1239752','1238708','1238039','1238038','1237864','1236455','1236454','1235814','1235813','1235812','1235811','1235810','1235809','1224653','1224650','1224649','1224648','1224647','1256618','1250282','1241237','1240364','1239687','1238817','1238761','1235291','1232076','1228000','1222208','1222074','1193414','1191699','1185437','1180399','1179172','1178530','1172874','1160091','1253617','1253534','1248992','1247975','1247614','1244851','1243016','1242886','1237259','1228999','1200018','1192768','1019889','1059208','1059603','1072636','1075005','1088226','1088707','1096073','1098958','1100582','1110956','1114957','1121073','1130437','1221403','1131637','1135726','1141261','1141679','1215054','1202626','1147705','1158337','1119729','1122525','1124712','1215183','1117865','1220068','1256080','1256075','1255413','1247776')
ORDER BY ITIQUETE, IMENSAJE
	
	
	

	^_^ 'MINI-CONSULTAS DE PRUEBAS'	
	
SELECT T1.*, T7.ITITULO, T2.NTEMA 
FROM SOP_TIQUETES T1
LEFT JOIN SOP_TEMAS T2 ON T1.ITEMA=T2.ITEMA
LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA = T7.ITITULO --Este campo se refiere al campo en Is_Clientes de "Estado de solicitud"
LEFT JOIN ABADTIT T6 ON T6.ITABLA = 'ITDSOLICITUDC' AND T1.ITDSOLICITUD = T6.ITITULO
WHERE FHCIERRE >'2024-12-30'
AND FHCIERRE < '2025-01-01'

SELECT *
FROM CONSULTADCEBALLOS c 
WHERE ITIQUETE IN ('1193160','1142255','1178274','1018091','1196454')

SELECT DISTINCT (ITABLA)
FROM ABADTIT
WHERE  ITABLA = 'ITDSOLICITUDA'

SELECT ITIQUETE, ASIGNADOA, ABIERTOPOR 
FROM SOP_TIQUETES
WHERE ITIQUETE IN ('302748','302775','302874','302902','303073','303083','303108','1259371','1261758','1273174','1248083','1261842','1263123','1274287','1232769','1262043','1259645','1275077')


SELECT *
FROM ABADTIT
WHERE  ITABLA = 'ITDSOLICITUD'

SELECT DISTINCT T1.ITDSOLICITUDA, T7.NTITULO 
FROM SOP_TIQUETES T1
LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ITDSOLICITUD' AND T1.ITDSOLICITUDA = T7.ITITULO

SELECT *
FROM SOP_TIQUETES
WHERE ITIQUETEREF IN ('1238817')
	
SELECT IPQR, ITIQUETE 
	FROM SOP_PQRSPORTIQUETE
	--WHERE IPQR IN ('294973','881834','884303','897070','934085','935239','943084','951232','962286','1006801','1017991','1039443','1046605','1056341','1059208','1061772','1066027','1066027','1074141','1095180','1098958','1131323','1132313','1142952','1142983','1144937','1147346','1147346','1149657','1150842','1164713','1165493')
	WHERE IPQR IN ('1250854')
	
SELECT ITIQUETE, ESTADOTIQUETE, NTEMA, TIPOSOLICITUDAPERTURA, FECHAAPERTURA, FECHASOLUCION, FECHACIERRE 
	--FROM SOP_TIQUETES
	FROM CONSULTADCEBALLOS
	WHERE ASIGNADOA IN ('TLEON')
	AND FECHAAPERTURA > '2024-08-01'
	AND ESTADOTIQUETE NOT IN ('TK Cerrado')
	--WHERE ITIQUETE IN ('1252861','1251079','1250500','1250499','1250498','1250497','1246783','1239761','1239760','1239754','1239752','1238708','1238039','1238038','1237864','1236455','1236454','1235814','1235813','1235812','1235811','1235810','1235809','1224653','1224650','1224649','1224648','1224647','1256618','1250282','1241237','1240364','1239687','1238817','1238761','1235291','1232076','1228000','1222208','1222074','1193414','1191699','1185437','1180399','1179172','1178530','1172874','1160091','1253617','1253534','1248992','1247975','1247614','1244851','1243016','1242886','1237259','1228999','1200018','1192768','1019889','1059208','1059603','1072636','1075005','1088226','1088707','1096073','1098958','1100582','1110956','1114957','1121073','1130437','1221403','1131637','1135726','1141261','1141679','1215054','1202626','1147705','1158337','1119729','1122525','1124712','1215183','1117865','1220068','1256080','1256075','1255413','1247776')
		
SELECT ITIQUETE, ITIQUETEREF, ASIGNADOA 
	FROM SOP_TIQUETES st 
	WHERE ITIQUETEREF IN ('1247975')
	--WHERE ITIQUETEREF IN ('294973','881834','884303','897070','934085','935239','943084','951232','962286','1006801','1017991','1039443','1046605','1056341','1059208','1061772','1066027','1066027','1074141','1095180','1098958','1131323','1132313','1142952','1142983','1144937','1147346','1147346','1149657','1150842','1164713','1165493')
		
SELECT ITIQUETE, ESTADOTIQUETE, ASIGNADOA, NTEMA, FECHAAPERTURA, FECHASOLUCION, FECHACIERRE, TIPOSOLICITUDAPERTURA 
	FROM CONSULTADCEBALLOS
	WHERE ASIGNADOA IN ('ACESPEDES')
	--AND (ESTADOTIQUETE NOT IN ('TK Cerrado') OR FECHACIERRE < '2025-05-01')
	AND NTEMA LIKE '%Sop AT%'
	AND FECHAAPERTURA > '2025-02-28'
	ORDER BY FECHAAPERTURA DESC 	

SELECT *
FROM SOP_TEMAS st 

--SQL para saber qué tiquetes tiene X especialista sin atender o sin solucionar
SELECT *
FROM CONSULTADCEBALLOS 
WHERE ESTADOTIQUETE NOT IN ('TK Cerrado','TK Solucionado')
AND ASIGNADOA IN ('ACESPEDES')
AND FECHASOLUCION IS NULL



SELECT max(iperfiltema)
FROM SOP_PERFILESPORTEMA




	╰(*°▽°*)╯	'CONSULTAR PARA LLEVAR EL CONTROL DE TKS ATE'	

--Query para BD para APRIETO (Tiempos ATE según tipos )
	SELECT T2.*,
	T1.FHAPERTURA,
	T1.FHASIGNACION,
	T1.FHATENDIDO,
	T1.FHSOLUCIONADO,
	T1.FHCIERRE,
	T1.BEXCLUIRINFORMES 
	FROM CONSULTADCEBALLOS T2
	LEFT JOIN SOP_TIQUETES T1 ON T1.ITIQUETE = T2.ITIQUETE
	WHERE T2.ASIGNADOA IN ('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON')
	AND T1.ITIQUETE NOT IN ('1252926','1253568','1239875','1249713','1036248','1249358') --Acá coloco los tiquetes que deberíamos excluir ya que son novedades que se presentan

		
--Query para BD Control de Tiquetes ATE
SELECT T2.*,
T1.FHAPERTURA,
T1.FHASIGNACION,
T1.FHATENDIDO,
T1.FHSOLUCIONADO,
T1.FHCIERRE,
T1.BEXCLUIRINFORMES 
FROM CONSULTADCEBALLOS T2
LEFT JOIN SOP_TIQUETES T1 ON T1.ITIQUETE = T2.ITIQUETE
WHERE T2.ASIGNADOA IN ('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON','EDUQUE','SCALLE','JCASTILLO')
AND T2.ESTADOTIQUETE <> ('TK Cerrado')
--AND T2.FECHAAPERTURA > '2024-12-31'
--T2.ASIGNADOA IN ('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON','PRENDON','ESUAREZ', 'DOCAMPO','DHURTADO')

--Query para revisar los tiquetes pendientes por atender
	SELECT T2.ITIQUETE, T2.IPRIORIDAD, T2.ASIGNADOA, T2.NTEMA,T2.FECHAAPERTURA,  
	DATEADD(HOUR,5,T1.FHAPERTURA) AS FHLIMITEATENCION,
	CASE 
        WHEN CURRENT_DATE > DATEADD(HOUR, 5, T1.FHAPERTURA) THEN 'VENCIDO'
        ELSE 'A TIEMPO'
    END AS estado_atencion, T2.TIPOSOLICITUDAPERTURA, T2.ESTADOTIQUETE
	FROM CONSULTADCEBALLOS T2
	LEFT JOIN SOP_TIQUETES T1 ON T1.ITIQUETE=T2.ITIQUETE
	WHERE T2.ASIGNADOA IN ('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON')
	AND T2.ESTADOTIQUETE = 'TK Sin Atender'
	AND T2.TIPOSOLICITUDAPERTURA NOT IN ('1 - PQR mejora') --Para NO incluir lo que esté abierto como mejora.
	AND T2.TIPOSOLICITUDAPERTURA NOT IN ('2 - AT - Tarea AT','6 - ADMON Certificación','6 - ADMON Certificación doble') -- Para NO incluir lo que esté abierto como tarea de ATE o CERTI
	ORDER BY T2.FECHAAPERTURA DESC 
	
--Quiery para revisar avance de ACESPEDES
	SELECT *
	FROM(
	SELECT T1.ITIQUETE,T5.ESTADOTIQUETE,T2.NTEMA,T4.NTITULO,T1.FHAPERTURA,T1.FHSOLUCIONADO,LOCALTIMESTAMP-T1.FHAPERTURA AS TIEMPO_DESDE_APERTURA,LOCALTIMESTAMP-MAX(T3.FHMENSAJE) AS FECHA_ULTIMO_MENSAJE, T1.IUSUARIOULT
	FROM SOP_TIQUETES T1
	LEFT JOIN SOP_TEMAS T2 ON T1.ITEMA=T2.ITEMA
	LEFT JOIN SOP_MENSAJES T3 ON T1.ITIQUETE=T3.ITIQUETE
	LEFT JOIN ABADTIT T4 ON T4.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T4.ITITULO
	LEFT JOIN CONSULTADCEBALLOS T5 ON T5.ITIQUETE=T1.ITIQUETE
	WHERE T1.ASIGNADOA='ACESPEDES'
	AND T1.FHCIERRE IS NULL
	AND T1.FHAPERTURA > '2024-01-01'
	--AND T1.ITIQUETE IN ('1119729','1122525','1124712','1247776','1255413','1256075','1256080','1264339','1261194','1261203','1261214','1160091','1172874','1179172','1180399','1185437','1193414','1238708','1239752','1239754','1239760','1239761','1246783','1250497','1250498','1250499','1250500','1251079','1252861','1265233','1238039','1238038','1236454','1236455','1237864','1235814','1235813','1235812','1235811','1235810','1235809','1215183','1059603','1075005','1096073','1098958','1100582','1019889','1114957','1220068','1222074','1222208','1135726','1131637','1141679','1224647','1215054','1224648','1224649','1228000','1243016','1247614','1247975','1253534','1253617','1224650','1224653','1228999','1265768','1263647','1262732','1262328','1158337','1059208','1072636','1088226','1088707','1121073','1110956','1147705','1141261','1232076','1235291','1244851','1130437','1202626','1221403','1237259','1238761','1238817','1239687','1242886','1241237','1248992','1250282','1263704','1240364','1256618','1268921','1218935','1233272','1268659','1269309','1269319','1269651','1271328','1272513','1272514','1272515','1272516','1272517','1272518','1273318','1273355','1275768','1275796')
	--AND T1.ITIQUETE IN ('1256618','1242886','1239687','1238761','1238817','1235291','1232076','1228999','1222074','1222208','1215054','1215183','1193414','1185437','1180399','1179172','1160091','1141261','1131637','1124712','1110956','1088707','1075005','1072636','1059208','1059603','1262328','1262732','1263647','1263704','1265768','1268921','1256075','1256080','1255413','1253534','1253617','1247614','1247776','1244851','1243016','1241237','1240364','1228000','1261194','1264339','1252861','1251079','1250282','1250497','1250498','1250499','1250500','1248992','1246783','1239752','1239754','1239760','1239761','1238708','1237864','1238038','1238039','1236454','1236455','1235809','1235810','1235811','1235812','1235813','1235814','1224647','1224648','1224649','1224650','1224653','1221403','1220068','1202626','1172874','1158337','1147705','1141679','1135726','1130437','1122525','1121073','1119729','1114957','1100582','1098958','1096073','1088226','1019889','1261203','1261214','1265233','1247975','1237259')
	--AND T1.FHSOLUCIONADO IS NULL
	--AND T3.REMITENTE='ACESPEDES'
	GROUP BY T1.ITIQUETE,T5.ESTADOTIQUETE,T2.NTEMA,T4.NTITULO,T1.FHAPERTURA,T1.FHSOLUCIONADO, T1.IUSUARIOULT
	)
	ORDER BY NTEMA,FECHA_ULTIMO_MENSAJE DESC										
											
	
	
'CONSULTAS DE TERCEROS'
	
--base
	SELECT FIRST 50 *
	FROM TERCEROS 
	
	SELECT DISTINCT(IACTECONOMICA)
	FROM TERCEROS T2
	--LEFT JOIN SECTOR T3 ON T3.ISECTOR =  T2.ITDSECTOR 
	LEFT JOIN ACTIVIDAD T4 ON T4.IACTIVIDAD =  T2.IACTECONOMICA 

--Consultar la cantidad de terceros tipos cliente (ITDTERCERO = 2) de un municipio
	SELECT ITERCERO 
	--COUNT(DISTINCT ITERCERO) 
	FROM TERCEROS
	WHERE IDEPARTAMENTO = '54'
	AND IPAIS = '169'
	AND ICIUDAD IN ('003','206','245','485','720','800','810','498')
	AND ITDTERCERO = '2'
	
--Lista de clientes para cuya actividad económica sea juegos de azar, notarías o exportación de petróleo y café.
	SELECT *
	FROM TERCEROS
	WHERE ITDTERCERO = '2' --El 2 define qué terceros son clientes. El número 1 son los prospectos.
	
--Consulta para ver en qué fecha actualizó un tercero
	SELECT MIN(FREGISTRO) 
	FROM REGINISIS_MENSAJES
	WHERE ITERCERO IN ('900587504')
	AND IACTUALIZACION = 24
	AND ICOMPILACION = 3
	
	SELECT *
	FROM REGINISIS_MENSAJES
	WHERE ITERCERO='900587504'
	ORDER BY FREGISTRO  DESC
	
	'CONSULTA PARA LLEVAR EL CONTROL DE ENTREGA DE MEJORAS'
	
--Query de mejoras pendientes por gestionar
	SELECT  ITIQUETE,
	ASIGNADOA,
	ESTADOTIQUETE,
	NTEMA,
	FECHAAPERTURA,
	TIPOSOLICITUDAPERTURA,
	ESTADOTK 
	FROM CONSULTADCEBALLOS
	WHERE ASIGNADOA IN ('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON')
	AND TIPOSOLICITUDAPERTURA IN ('1 - PQR mejora','A - PQR adición o mejora','1 - PQR Ajuste del sistema')
	AND ESTADOTIQUETE <> ('TK Cerrado')
	--AND ANIOAPERTURA > '2024'
	
--Query para alimentar la BD del archivo "Análisis mejoras (desde 2024)"
	SELECT *
	FROM CONSULTADCEBALLOS
	
--Query para colocar los tiempos de las mejoras cerradas en un mes X
	SELECT
		T1.ITIQUETE AS ITIQUETE,
		T3.NTEMA AS tema,
		T1.ASIGNADOA AS gestiona,
		CAST(t1.FHAPERTURA AS DATE) AS FHAPERTURA,
		T8.NTITULO AS TIPO_CIERRE,
		(T1.QMINATENCIONEMPRESA/60.00) AS TA,
		(T1.QMINSOLUCIONEMPRESA/60.00) AS TS,
		(T1.QMINCIERREEMPRESA/60.00) AS TC
		FROM SOP_TIQUETES T1
		LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA
		LEFT JOIN ABADTIT T5 ON T5.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T5.ITITULO --tipo solicitud de apertura
		LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA = T7.ITITULO --Estado de solicitid
		LEFT JOIN ABADTIT T8 ON T8.ITABLA = 'ITDSOLICITUDC' AND T1.ITDSOLICITUD = T8.ITITULO --Tipo de solicitud de cierre
		WHERE 
		T1.BANULADO='F'
	    AND EXTRACT(MONTH FROM T1.FHCIERRE) = :MES
        AND EXTRACT(YEAR FROM T1.FHCIERRE) = :ANIO
		--AND EXTRACT(MONTH FROM T1.FHAPERTURA) = :MES
        --AND EXTRACT(YEAR FROM T1.FHAPERTURA) = :ANIO
		AND T5.NTITULO IN ('1 - PQR mejora','A - PQR adición o mejora') 
		AND T1.ASIGNADOA IN('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON')
		--AND T1.ITIQUETE IN ('1202998','1205006')
		ORDER BY T1.ASIGNADOA ASC
	

--Para revisar el estado de la mejoras
	SELECT ITIQUETE,
	CASE
		WHEN FHCIERRE IS NOT NULL THEN 'Cerrado'
		WHEN FHSOLUCIONADO IS NOT NULL THEN 'Solucionado'
		WHEN FHSOLUCIONADO IS NULL AND BPQR = 'T' THEN 'Escalado'
		WHEN FHATENDIDO IS NOT NULL THEN 'Atendido'
		ELSE 'Sin atender'
	END AS ESTADO
	FROM SOP_TIQUETES
	--WHERE ITIQUETE IN ('1227364','1228350','1229910','1229940','1229959','1229966','1187126','1187126','931671','1139963','1185609','938217','1114733','1114733','1226207','1226124','1226160','1244935','1245206')
	WHERE ITIQUETE IN ('883575','928961','940896','947995','1058100','952460','1057949','1181711','930006','1244935','1245206')

--Query para consulta de tiempos promedio de atención, solución y cierre de mejoras
	WITH X1 AS(
	SELECT
		T1.ITIQUETE AS ITIQUETE,
		T3.NTEMA AS tema,
		T1.ASIGNADOA AS gestiona,
		T1.FHAPERTURA,
		T1.FHATENDIDO,
		T1.FHSOLUCIONADO,
		T1.FHCIERRE,
		T5.NTITULO AS TIPO_SOLICITUD_APERTURA,
		T7.NTITULO AS ESTADODESOLICITUD,
		T8.NTITULO AS TIPO_CIERRE,
		CASE
			WHEN T1.FHCIERRE IS NOT NULL THEN 'Cerrado'
			WHEN T1.FHATENDIDO IS NULL THEN 'Sin atender'
			WHEN T1.FHSOLUCIONADO IS NULL AND T1.BPQR = 'T' THEN 'Escalado a ING - Sin solucionar'
			WHEN T1.FHSOLUCIONADO IS NULL THEN 'Sin solucionar'
		END AS ESTADO,
		(T1.QMINATENCIONEMPRESA/60.00) AS TA,
		(T1.QMINSOLUCIONEMPRESA/60.00) AS TS,
		(T1.QMINCIERREEMPRESA/60.00) AS TC
		FROM SOP_TIQUETES T1
		LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA
		LEFT JOIN ABADTIT T5 ON T5.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T5.ITITULO --tipo solicitud de apertura
		LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA = T7.ITITULO --Estado de solicitid
		LEFT JOIN ABADTIT T8 ON T8.ITABLA = 'ITDSOLICITUDC' AND T1.ITDSOLICITUD = T8.ITITULO --Tipo de solicitud de cierre
		WHERE 
		T1.BANULADO='F'
	    AND EXTRACT(MONTH FROM T1.FHCIERRE) = :MES
        AND EXTRACT(YEAR FROM T1.FHCIERRE) = :ANIO
		--AND EXTRACT(MONTH FROM T1.FHAPERTURA) = :MES
        --AND EXTRACT(YEAR FROM T1.FHAPERTURA) = :ANIO
		AND T5.NTITULO IN ('1 - PQR mejora','A - PQR adición o mejora') 
		AND T1.ASIGNADOA IN('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON')
		--AND T1.ITIQUETE IN ('1202998','1205006')
		ORDER BY T1.ASIGNADOA ASC)
		SELECT COUNT(ITIQUETE),
		AVG(TA) AS PROM_TA,
		AVG(TS) AS PROM_TS,
		AVG(TC) AS PROM_TC
		FROM X1
		GROUP BY ITIQUETE
	
--Query para consultar el estado de las mejoras (Revisar tiempos detallados por fecha de apertura)
	SELECT
		T1.ITIQUETE,
		T1.ASIGNADOA AS gestiona,
		T3.NTEMA AS tema,
		T4.NCLASIFICADOR AS CLASIFICADOR,
		T1.FHAPERTURA,
		T1.FHATENDIDO,
		T1.FHSOLUCIONADO,
		T1.FHCIERRE,
		T5.NTITULO AS TIPO_SOLICITUD_APERTURA,
		T7.NTITULO AS ESTADODESOLICITUD,
		CASE
			WHEN T1.FHCIERRE >= DATEADD(MONTH,-3,CURRENT_DATE) THEN 'Cerrado hace más de 3 meses'
			WHEN T1.FHCIERRE IS NOT NULL THEN 'Cerrado'
			WHEN T1.FHATENDIDO IS NULL THEN 'Sin atender'
			WHEN T1.FHSOLUCIONADO IS NULL AND T1.BPQR = 'T' THEN 'Escalado a ING - Sin solucionar'
			WHEN T1.FHSOLUCIONADO IS NULL THEN 'Sin solucionar'
		END AS ESTADO,
		(T1.QMINATENCIONEMPRESA/60.00) AS TA,
		(T1.QMINSOLUCIONEMPRESA/60.00) AS TS,
		(T1.QMINCIERREEMPRESA/60.00) AS TC
		FROM SOP_TIQUETES T1
		LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA
		LEFT JOIN ABADTIT T5 ON T5.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T5.ITITULO --tipo solicitud de apertura
		LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA = T7.ITITULO
		LEFT JOIN SOP_CLASIFICADORES T4 ON T1.ITEMA=T4.ITEMA AND T1.ICLASIFICADOR=T4.ICLASIFICADOR
		WHERE 
		T1.BANULADO='F'
		AND T5.NTITULO IN ('1 - PQR mejora','A - PQR adición o mejora','1 - PQR Ajuste del sistema') 
		AND T1.ASIGNADOA IN('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON')
		--AND T1.ITIQUETE IN ('1202998','1205006')
		ORDER BY T1.ASIGNADOA ASC
	
--Para hallar los tiquetes escalados hacia arriba y hacia abajo
	SELECT ITIQUETE, ITIQUETEREF, ABIERTOPOR 
	FROM SOP_TIQUETES
	--WHERE ITIQUETE IN ('1227364','1228350','1229910','1229940','1229959','1229966','1187126','1187126','931671','1139963','1185609','938217','1114733','1114733','1226207','1226124','1226160','1244935','1245206')
	WHERE ITIQUETE IN ('1184920','1184920','930741','937359','1114722','1114722')
	--WHERE ITIQUETEREF IN ('1244472')
	
--Prueba para seguimiento de tiquetes ATE	
	SELECT *
	FROM CONSULTADCEBALLOS
	WHERE FECHAAPERTURA > '2025-03-01'
	AND ASIGNADOA IN ('SALARCON', 'ACESPEDES', 'ATORO', 'AGIL', 'TLEON', 'VRESTREPO')
	
--Prueba para seguimiento de tiquetes ATE	2
	SELECT T2.ITIQUETE,
	T2.ASIGNADOA,
	T2.FECHAAPERTURA,
	CASE
		--WHEN T1.FHCIERRE >= DATEADD(MONTH,-1,CURRENT_DATE) THEN 'Cerrado hace más de 1 mes'
		WHEN T1.FHCIERRE IS NOT NULL THEN 'Cerrado'
		WHEN T1.FHATENDIDO IS NULL THEN 'Sin atender'
		WHEN T1.FHSOLUCIONADO IS NULL AND T1.BPQR = 'T' THEN 'Escalado a ING - Sin solucionar'
		WHEN T1.FHSOLUCIONADO IS NULL THEN 'Sin solucionar'
	END AS ESTADO
	FROM CONSULTADCEBALLOS T2
	LEFT JOIN SOP_TIQUETES T1 ON T1.ITIQUETE = T2.ITIQUETE 
	WHERE T2.FECHAAPERTURA > '2025-03-01'
	AND T2.ASIGNADOA IN ('SALARCON', 'ACESPEDES', 'ATORO', 'AGIL', 'TLEON', 'VRESTREPO')
	
'CONSULTA PARA EL CONTROL DE NOVEDADES DE UNA ACTU'	

--Consulta para ver la cantidad de tiquetes escalados con una novedad desde N1 a ING
	WITH X1 AS
  (
  SELECT T1.IPQR AS IPQR,COUNT(T1.IPQR) AS CUENTA
  FROM SOP_PQRSPORTIQUETE T1
  LEFT JOIN SOP_TIQUETES T2 ON T1.IPQR=T2.ITIQUETE
  LEFT JOIN SOP_TEMAS T3 ON T2.ITEMA=T3.ITEMA
  --WHERE T2.BANULADO='F'
  --AND T2.IACTUALIZACION=:ACTUALIZACION
  --AND T2.IBUILD=:COMPILADO
  GROUP BY T1.IPQR
  ORDER BY T1.IPQR DESC
  )
  SELECT T3.NTEMA,CASE WHEN CHAR_LENGTH(T1.IBUILD) = 1 THEN 'A'||T1.IACTUALIZACION||',0' || T1.IBUILD ELSE 'A'||T1.IACTUALIZACION||',' || T1.IBUILD END AS ACTUALIZACION,T1.ASIGNADOA,T1.ABIERTOPOR AS CREADOPOR,T1.ITIQUETE AS PQR_ING,T1.ITIQUETEREF AS TK_AT,T2.ITIQUETEREF AS TK_N2,X1.CUENTA AS USUARIOSIMPACTADOS
  FROM SOP_TIQUETES T1
  LEFT JOIN SOP_TIQUETES T2 ON T1.ITIQUETEREF=T2.ITIQUETE
  LEFT JOIN X1 ON T2.ITIQUETEREF=X1.IPQR
  LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA --Se une para traer el nombre del tema
  LEFT JOIN ABADTIT T6 ON T6.ITABLA='ITDSOLICITUDC' AND T1.ITDSOLICITUD=T6.ITITULO --Se une para traer tipo de solicitud de cierre
  WHERE 
  T1.ASIGNADOA IN ('DOCAMPO','ESUAREZ','PRENDON','DHURTADO') 
  AND T1.BANULADO='F'
  AND T2.BANULADO='F'
  --AND T1.ITIQUETEREF IS NOT NULL
  --AND T2.ITIQUETEREF IS NOT NULL
  AND T1.IACTUALIZACION IN :ACTUALIZACION
  AND T1.IBUILD IN :COMPILADO 
  AND T3.NTEMA LIKE '%Sop Ing%' --Solo se tienen en cuenta PQRs cuyo tema contenga Sop Ing
  AND T1.IMOTIVO=0 -- 0 para PQRs de producción
  AND T6.NTITULO IN ('C - Error del sistema','PQR Error del sistema','1 - PQR - Error del sistema','1- PQR - Error del sistema (causa no identificada)','1 - PQR - Error por cambio anterior (para uso AT e ING únicamente)','1 - PQR - Error del sistema (causa no identificada)','1 - PQR - Error por caso nuevo (para uso AT e ING únicamente)','1 - PQR - Error por normativa (para uso AT e ING únicamente)')
  ORDER BY X1.CUENTA DESC
      
--Archivo 1 para revisar caso de NC
WITH T1 AS 
  (
  SELECT ITERCERO,
  --FREGISTRO,
  CASE 
  WHEN CHAR_LENGTH(ICOMPILACION)=2 THEN IRELEASE||','||IACTUALIZACION||','||ICOMPILACION
  ELSE IRELEASE||','||IACTUALIZACION||',0'||ICOMPILACION
  END AS CONCATENADOA
  FROM REGINISIS_MENSAJES T1
  WHERE ICOMPILACION>=0 AND ITERCERO IS NOT NULL
  )
  SELECT 
  T1.ITERCERO
  ,MAX(T1.CONCATENADOA) AS CONCATENADOB
  ,T2.IEMPPROPIETARIO
  FROM T1
  LEFT JOIN TERCEROS T2 ON T1.ITERCERO=T2.ITERCERO
  GROUP BY T1.ITERCERO,T2.IEMPPROPIETARIO
  --HAVING MAX(CONCATENADOA)IN ('8,23,40','8,23,50','8,23,60')
  ORDER BY MAX(T1.CONCATENADOA) DESC