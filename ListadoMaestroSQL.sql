
'QUERYS GENERALES'

--Query para traer datos de la vista de consulta de TKs
SELECT *
FROM CONSULTADCEBALLOS

--Query para vista de consulta de TKs
CREATE OR ALTER VIEW ConsultaDCEBALLOS AS
SELECT
T1.ITIQUETE AS ITIQUETE,
TRIM(CASE 
	WHEN T1.IPRIORIDAD=4 THEN 'Máxima'
WHEN T1.IPRIORIDAD=3 THEN 'Alta'
WHEN T1.IPRIORIDAD=2 THEN 'Normal'
WHEN T1.IPRIORIDAD=1 THEN 'Baja'
ELSE 'Sin prioridad'
END) AS IPRIORIDAD,
REPLACE(CAST(T1.QDEDICACION/60.00 AS VARCHAR(20)),'.',',') AS QDEDICACION_HORAS,
T1.ITIQUETEREF,
T1.ITIQUETEBASE,
T2.IPQR,
TRIM(CASE 
	WHEN T1.BANULADO='T' THEN 'TK Anulado' 
WHEN T1.FHCIERRE IS NOT NULL THEN 'TK Cerrado' 
WHEN T1.FHSOLUCIONADO IS NOT NULL THEN 'TK Solucionado'
WHEN T1.FHATENDIDO IS NOT NULL THEN 'TK Atendido'
WHEN T1.FHATENDIDO IS NULL THEN 'TK Sin Atender'
ELSE 'Error Revisar SQL'
END) AS EstadoTiquete,
T1.IAPLICACION,
T1.IVERSION,
T1.IRELEASE,
T1.IACTUALIZACION,
IBUILD,
'V' || COALESCE(T1.IVERSION,'') || ' R' || COALESCE(T1.IRELEASE,'') || ' A' || COALESCE(T1.IACTUALIZACION,'') || ',' || COALESCE(T1.IBUILD,'')AS CONCAT_VER_REL_ACT_COMP,
T1.ABIERTOPOR AS USUARIOCREACION,
T1.ASIGNADOA,
T1.ITEMA,
T3.NTEMA,
T3.NCATEGORIA,
TRIM(CASE 
	WHEN T3.NCATEGORIA='AT - Apoyo' AND T3.NTEMA LIKE '%Sop AT%' THEN 'AT - Soporte'
WHEN T3.NCATEGORIA='AT - Apoyo' AND T3.NTEMA NOT LIKE '%Sop AT%' THEN 'AT - Apoyo'
WHEN T3.NCATEGORIA='AT - Apoyo Ing' THEN 'AT - Apoyo Ing'
WHEN T3.NCATEGORIA='AT - Calidad' THEN 'AT - Calidad'
WHEN T3.NCATEGORIA='AT - Capacitación' THEN 'AT - Capacitación'
WHEN T3.NCATEGORIA='ÁT - Contenido' THEN 'ÁT - Contenido'
WHEN T3.NCATEGORIA='AT - Vigilancia' THEN 'AT - Vigilancia'
WHEN T3.NCATEGORIA='ContaPyme' THEN 'Sop Ing CP'
WHEN T3.NCATEGORIA='Páginas web' THEN 'Sop Ing Páginas Web'
WHEN T3.NCATEGORIA='Sistemas internos' THEN 'Sop Ing Sistemas Internos'
WHEN T3.NCATEGORIA IN ('Inicio Servicios Electrónicos','Soporte General','Soporte Servicios Electrónicos') THEN 'Sop General N1'			
WHEN T3.NCATEGORIA='Soporte asesores interno' THEN 'Sop General N2 o interno N1'			
WHEN T3.NCATEGORIA IN ('Distribuidores - Inicio Servicios Electrónicos','Distribuidores - Soporte General','Distribuidores - Soporte Premium','Distribuidores - Soporte Servicios Electrónicos') THEN 'Soporte a Distri'
ELSE 'Error Revisar SQL'
END) AS ClasificacionTema,
T1.ICLASIFICADOR,
T4.NCLASIFICADOR,
TRIM(CASE
	WHEN T1.IMOTIVO=1 THEN 'Pruebas'
WHEN T1.IMOTIVO=0 THEN 'Produccion'
WHEN T1.IMOTIVO IS NULL THEN 'Sin ambiente'
ELSE 'Revisar'
END) AS Ambiente,
CAST(T1.FHAPERTURA AS DATE) AS FechaApertura,
TRIM(CASE EXTRACT(MONTH FROM T1.FHAPERTURA)
	WHEN 1 THEN 'Enero'
WHEN 2 THEN 'Febrero'
WHEN 3 THEN 'Marzo'
WHEN 4 THEN 'Abril'
WHEN 5 THEN 'Mayo'
WHEN 6 THEN 'Junio'
WHEN 7 THEN 'Julio'
WHEN 8 THEN 'Agosto'
WHEN 9 THEN 'Septiembre'
WHEN 10 THEN 'Octubre'
WHEN 11 THEN 'Noviembre'
WHEN 12 THEN 'Diciembre'
END) AS MesApertura,
EXTRACT(YEAR FROM T1.FHAPERTURA ) AS AnioApertura,
CAST(T1.FHATENDIDO  AS DATE) AS FechaAtencion,
TRIM(CASE EXTRACT(MONTH FROM T1.FHATENDIDO)
	WHEN 1 THEN 'Enero'
WHEN 2 THEN 'Febrero'
WHEN 3 THEN 'Marzo'
WHEN 4 THEN 'Abril'
WHEN 5 THEN 'Mayo'
WHEN 6 THEN 'Junio'
WHEN 7 THEN 'Julio'
WHEN 8 THEN 'Agosto'
WHEN 9 THEN 'Septiembre'
WHEN 10 THEN 'Octubre'
WHEN 11 THEN 'Noviembre'
WHEN 12 THEN 'Diciembre'
END) AS MesAtencion,
EXTRACT(YEAR FROM T1.FHATENDIDO ) AS AnioAtencion,	
CAST(T1.FHSOLUCIONADO  AS DATE) AS FechaSolucion,
TRIM(CASE EXTRACT(MONTH FROM T1.FHSOLUCIONADO)
	WHEN 1 THEN 'Enero'
WHEN 2 THEN 'Febrero'
WHEN 3 THEN 'Marzo'
WHEN 4 THEN 'Abril'
WHEN 5 THEN 'Mayo'
WHEN 6 THEN 'Junio'
WHEN 7 THEN 'Julio'
WHEN 8 THEN 'Agosto'
WHEN 9 THEN 'Septiembre'
WHEN 10 THEN 'Octubre'
WHEN 11 THEN 'Noviembre'
WHEN 12 THEN 'Diciembre'
END) AS MesSolucion,		
EXTRACT(YEAR FROM T1.FHSOLUCIONADO ) AS AnioSolucion,		
CAST(T1.FHCIERRE AS DATE) AS FechaCierre,
TRIM(CASE EXTRACT(MONTH FROM T1.FHCIERRE)
	WHEN 1 THEN 'Enero'
WHEN 2 THEN 'Febrero'
WHEN 3 THEN 'Marzo'
WHEN 4 THEN 'Abril'
WHEN 5 THEN 'Mayo'
WHEN 6 THEN 'Junio'
WHEN 7 THEN 'Julio'
WHEN 8 THEN 'Agosto'
WHEN 9 THEN 'Septiembre'
WHEN 10 THEN 'Octubre'
WHEN 11 THEN 'Noviembre'
WHEN 12 THEN 'Diciembre'
END) AS MesCierre,	
EXTRACT(YEAR FROM T1.FHCIERRE ) AS AnioCierre,
EXTRACT(WEEK FROM T1.FHAPERTURA) AS SemanaApertura,
EXTRACT(WEEK FROM T1.FHATENDIDO) AS SemanaAtencion,
EXTRACT(WEEK FROM T1.FHSOLUCIONADO) AS SemanaSolucion,
EXTRACT(WEEK FROM T1.FHCIERRE) AS SemanaCierre,
REPLACE(CAST(T1.QMINATENCIONEMPRESA/60.00 AS VARCHAR(20)),'.',',') AS QHRATENCIONEMPRESA,
REPLACE(CAST(T1.QMINSOLUCIONEMPRESA/60.00 AS VARCHAR(20)),'.',',') AS QHRSOLUCIONEMPRESA,
REPLACE(CAST(T1.QMINCIERREEMPRESA/60.00 AS VARCHAR(20)),'.',',') AS QHRCIERREEMPRESA,  
T5.NTITULO AS TipoSolicitudApertura,
T6.NTITULO AS TipoSolicitudCierre,
TRIM(CASE 
	WHEN T6.NTITULO ='1 - PQR Cambio normativo' THEN 'Cambio normativo'
WHEN T6.NTITULO ='1 - PQR - Caso reasignado a otro Ingeniero' THEN 'Caso reasignado'
WHEN T6.NTITULO ='1 - Consulta' THEN 'Consulta'
WHEN T6.NTITULO IN ('1 - Envío instructivo (con asistencia)','1 - Envío instructivo (sin asistencia)') THEN 'Sop envío instructivo'
WHEN T6.NTITULO ='1 - PQR - Error del sistema (causa no identificada)' THEN 'Error causa no identificada'			
WHEN T6.NTITULO ='1 - PQR - Error por cambio anterior (para uso AT e ING únicamente)' THEN 'Error por cambio anterior'			
WHEN T6.NTITULO ='1 - PQR - Error por caso nuevo (para uso AT e ING únicamente)' THEN 'Error por caso nuevo'
WHEN T6.NTITULO ='1 - PQR - Error por normativa (para uso AT e ING únicamente)' THEN 'Error por normativa'	
WHEN T6.NTITULO ='1 - PQR - Error del sistema' THEN 'Error sistema'	
WHEN T6.NTITULO  IN ('1 - Falta de capacitación','1 - Falta de recurso','1 - Novedad de configuración') THEN 'Falsa alarma'
WHEN T6.NTITULO ='1 - Intermitencia servidores InSoft' THEN 'Intermitencia servidores InSoft'	
WHEN T6.NTITULO ='1 - PQR - Adición o mejora aprobada' THEN 'Mejora aprobada'	
WHEN T6.NTITULO ='1 - PQR - Adición o mejora rechazada' THEN 'Mejora rechazada'	
WHEN T6.NTITULO IN ('1 - Se envía material (Triage)','1 - Sesión OB Finalizada (consultar)','3 - COM  - Interfaz','3 - COM - Actualización Constante','3 - COM - Administración Centros de Costos','3 - COM - Administración de Múltiples Empresas','3 - COM - Capacitación','3 - COM - Compatibilidad con Excel','3 - COM - Facilidad de Uso','3 - COM - Inicio Fácil','3 - COM - Integración de Módulos','3 - COM - No compra','3 - COM - Presentación Informes','3 - COM - Servicio Soporte Técnico','3 - COM - Trazabilidad de Información','3 - COM - Usuarios y Perfiles de Seguridad','3 - POL - NO renueva poliza ','3 - POL - NO renueva por portal novedades tecnicas','3 - POL - NO renueva por portal pago programado','3 - POL - NO renueva por portal, Póliza vencida + 2 años','3 - POL - NO renueva por portal, cliente distribuidor','3 - POL - NO renueva por portal, cliente internacional','3 - POL - NO renueva por portal, poco amigable','3 - POL - NO renueva por portal, promoción vigente','3 - POL - Renueva poliza por portal','4 - CAL - Cliente desiste de cambio de distribuidor ','4 - CAL - Cliente desiste de devolución','4 - CAL - Cliente no conforme con respuesta','4 - CAL - Cliente no renueva póliza','4 - CAL - Cliente renueva póliza','4 - CAL - Inconformidad resuelta','4 - CAL - No procede','4 - CAL - No recepción de autorización','4 - CAL - Procede','4 - CAL - Seguimiento no realizado','4 - CAL - Solicitud resuelta','5 - CON - Gestión realizada','6 - ADMON Certificación aprobada','6 - ADMON Certificación no aprobada') THEN 'No aplica'	
WHEN T6.NTITULO IN ('1 - Intermitencia PT','1 - Intermitencia o problemas DIAN','1 - PQR - Error/Novedad externa') THEN 'Novedad externa'
WHEN T6.NTITULO ='1 - Novedad por antivirus' THEN 'Novedad por antivirus'			
WHEN T6.NTITULO ='1 - PQR - proyecto (para uso AT e ING únicamente)' THEN 'Proyecto'
WHEN T6.NTITULO ='1 - PQR - Requerimiento técnico (para uso AT e ING únicamente)' THEN 'Requerimiento técnico'
WHEN T6.NTITULO ='2 - AT - Tarea finalizada' THEN 'Tarea de AT'
WHEN T6.NTITULO IN ('1 - ING Servicios SQL','1 - ING Servicios otros ','1 - ING Servicios rep. BD') THEN 'Servicios'
WHEN T6.NTITULO IN ('1 - PQR Ajuste del sistema') THEN 'Ajuste'
WHEN T6.NTITULO='' OR T6.NTITULO IS NULL THEN 'Solicitud de cierre no diligenciado'
ELSE 'Nuevo tipo solicitud cierre'
END) AS ClasificacionSolicitudCierre,
T7.NTITULO AS EstadoTK,
T8.NTITULO AS TipoSolucion, 
T9.NTITULO AS CoberturaEstimada,
TRIM(CASE
	WHEN T1.ITEMA IN ('ING-51') THEN 'AA Ing'
WHEN T1.ITEMA IN ('ACTAUT') THEN 'AA Sop'
WHEN T1.ITEMA IN ('ING-18') THEN 'Activos Ing'
WHEN T1.ITEMA IN ('ACT') THEN 'Activos Sop'
WHEN T1.ITEMA IN ('ING-08') THEN 'AD Ing'
WHEN T1.ITEMA IN ('AUT') THEN 'AD Sop'
WHEN T1.ITEMA IN ('ING-50') THEN 'agrowin.com Ing'
WHEN T1.ITEMA IN ('ING-02') THEN 'API Ing'
WHEN T1.ITEMA IN ('SDAPI','APIBAS','APIAVA','APIPR') THEN 'API Sop'
WHEN T1.ITEMA IN ('ING-04') THEN 'Básico Ing'
WHEN T1.ITEMA IN ('SDSB','SOPDISPREM-SB','LS','MAIL','SIB') THEN 'Básico Sop'
WHEN T1.ITEMA IN ('ING-44','ING-39') THEN 'BO Ing'
WHEN T1.ITEMA IN ('SDBO','SOPDISPREM-BO','ADS','ASRC','BOATPT','BOFECA01','BONECA02','BONECA04','CEDS','ESTFE','FECACN01','FECACN02','RDCT','SR','SRCD') THEN 'BO Sop'
WHEN T1.ITEMA IN ('CAM') THEN 'Campañas Sop'
WHEN T1.ITEMA IN ('ING-07','ING-06') THEN 'Contabilidad Ing'
WHEN T1.ITEMA IN ('SDCN','SOPDISPREM-CN','CAR','CON','INT','MED','MEXT') THEN 'Contabilidad Sop'
WHEN T1.ITEMA IN ('ING-13') THEN 'ContaExcel Ing'
WHEN T1.ITEMA IN ('CEX','INSCEX') THEN 'ContaExcel Sop'
WHEN T1.ITEMA IN ('ING-36') THEN 'contapyme.com Ing'
WHEN T1.ITEMA IN ('ING-10') THEN 'Costos Ing'
WHEN T1.ITEMA IN ('SDCOS','SOPDISPREM-COS','COP') THEN 'Costos Sop'
WHEN T1.ITEMA IN ('ING-24') THEN 'DD Ing'
WHEN T1.ITEMA IN ('SDDD','SOPDISPREM-DD','DDO','DHTML') THEN 'DD Sop'
WHEN T1.ITEMA IN ('ING-12') THEN 'DSNO Ing'
WHEN T1.ITEMA IN ('SOPDISPREM-DS','SDDS','DS') THEN 'DSNO Sop'
WHEN T1.ITEMA IN ('ING-11') THEN 'FE Ing'
WHEN T1.ITEMA IN ('SOPDISPREM-FE','SOPDISPREM-FEPO','SDFE','SDFEPOS','SFE','FEPOS','NNC','BONECA03','ASRCA') THEN 'FE Sop'
WHEN T1.ITEMA IN ('ING-14') THEN 'Indicadores Ing'
WHEN T1.ITEMA IN ('IND') THEN 'Indicadores Sop'
WHEN T1.ITEMA IN ('ING-37') THEN 'insoftweb.com Ing'
WHEN T1.ITEMA IN ('ING-21','ING-22','ING-05','ING-01') THEN 'Instalación Ing'
WHEN T1.ITEMA IN ('SDST','SOPDISPREM-ST','LIC','ACTM','CODBC','ING','INSAD','INCP','RESIS','SIC','THS') THEN 'Instalación Sop'
WHEN T1.ITEMA IN ('ING-15','ING-16') THEN 'Inventarios Ing'
WHEN T1.ITEMA IN ('SDINV','SOPDISPREM-INV','INV') THEN 'Inventarios Sop'
WHEN T1.ITEMA IN ('ING-03') THEN 'Móvil Ing'
WHEN T1.ITEMA IN ('MOV','INSMOV') THEN 'Móvil Sop'
WHEN T1.ITEMA IN ('NOM') THEN 'Nómina contable Sop'
WHEN T1.ITEMA IN ('ING-17') THEN 'Nómina Ing'
WHEN T1.ITEMA IN ('SOPDISPREM-NE','SOPDISPREM-PILA','NED','SDPILA','PILA','NE') THEN 'Nómina Sop'
WHEN T1.ITEMA IN ('ING-40') THEN 'Notificaciones Ing'
WHEN T1.ITEMA IN ('ING-19') THEN 'Operaciones en bloque Ing'
WHEN T1.ITEMA IN ('OPRB') THEN 'Operaciones en bloque Sop'
WHEN T1.ITEMA IN ('ING-52') THEN 'Panel Administrativo Consultas SE Ing'
WHEN T1.ITEMA IN ('ING-20') THEN 'Plataforma Ing'
WHEN T1.ITEMA IN ('PLAT') THEN 'Plataforma Sop'
WHEN T1.ITEMA IN ('ING-49') THEN 'Portal Asesores Ing'
WHEN T1.ITEMA IN ('ING-35') THEN 'Portal de clientes Ing'
WHEN T1.ITEMA IN ('ING-09') THEN 'Presupuesto Ing'
WHEN T1.ITEMA IN ('PRE') THEN 'Presupuesto Sop'
WHEN T1.ITEMA IN ('ING-46') THEN 'RD Ing'
WHEN T1.ITEMA IN ('SOPDISPREM-RD','SDSRD','SRD') THEN 'RD Sop'
WHEN T1.ITEMA IN ('ING-26') THEN 'Sistema clientes Ing'
WHEN T1.ITEMA IN ('ING-47') THEN 'Restauración DB Ing'
WHEN T1.ITEMA IN ('ING-45') THEN 'Base de datos Ing'
WHEN T1.ITEMA IN ('SOP-CAP') THEN 'Capacitación clientes Sop'
WHEN T1.ITEMA IN ('SPOSTV') THEN 'Postventa Sop'
WHEN T1.ITEMA IN ('PSC') THEN 'Plataforma servicio al cliente Sop'
ELSE 'No es Sop N1 ni Ing'
END) AS EquivalenciaTema
FROM SOP_TIQUETES T1
LEFT JOIN SOP_PQRSPORTIQUETE T2 ON T1.ITIQUETE=T2.ITIQUETE
LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA
LEFT JOIN SOP_CLASIFICADORES T4 ON T1.ITEMA=T4.ITEMA AND T1.ICLASIFICADOR=T4.ICLASIFICADOR
LEFT JOIN ABADTIT T5 ON T5.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T5.ITITULO
LEFT JOIN ABADTIT T6 ON T6.ITABLA='ITDSOLICITUDC' AND T1.ITDSOLICITUD=T6.ITITULO
LEFT JOIN ABADTIT T7 ON T7.ITABLA='ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA=T7.ITITULO
LEFT JOIN ABADTIT T8 ON T8.ITABLA='ITDSOLUCION' AND T1.ITDSOLUCION=T8.ITITULO
LEFT JOIN ABADTIT T9 ON T9.ITABLA='ITDCOBERTURAESTIMADA' AND T1.ITDCOBERTURAESTIMADA=T9.ITITULO
WHERE T1.FHAPERTURA>= '2024-01-01' 
AND T1.BANULADO='F'
AND T1.IEMPRESA='810000630' --SOLO SE TIENE EN CUENTA INSOFT
AND T3.NCATEGORIA IN ('API','AT - Apoyo','AT - Apoyo Ing','AT - Calidad','AT - Capacitación','ÁT - Contenido','AT - Vigilancia','ContaPyme','Distribuidores - Inicio Servicios Electrónicos','Distribuidores - Soporte General','Distribuidores - Soporte Premium','Distribuidores - Soporte Servicios Electrónicos','Inicio Servicios Electrónicos','Páginas web','Sistemas internos','Soporte General','Soporte Servicios Electrónicos','Soporte asesores interno','DIS - Soporte General','DIS - Soporte Premium','DIS - Soporte Servicios Electrónicos')		
ORDER BY T1.ITIQUETE asc

--Query para sacar fecha de lanzamiento de todas las actualizaciones
SELECT
CASE
	WHEN CHAR_LENGTH(IBUILD)=1 THEN 'V'||IVERSION||' R'||IRELEASE||' Act'||IPARCHE||',0'||IBUILD
ELSE 'V'||IVERSION||' R'||IRELEASE||' Act'||IPARCHE||','||IBUILD
END AS ACTUALIZACION
,FACTUALIZACION AS FechaActualizacion
--,BSALEACLIENTES
--,BSHOWCP
,STITULO
FROM CARACTERISTICASYRELEASES
WHERE 
--BSALEACLIENTES='T'AND 
FACTUALIZACION BETWEEN DATEADD(-12 MONTH TO LOCALTIMESTAMP) AND LOCALTIMESTAMP
ORDER BY FACTUALIZACION DESC

--Query para enviar uso de CP por TERCERO en los últimos 6 meses para operaciones desagregado por release(1 vez al mes)
WITH T1 AS(SELECT
ITERCERO
,EXTRACT(MONTH FROM FREGISTRO) AS MES
,EXTRACT(YEAR FROM FREGISTRO) AS ANIO
,COUNT(ITERCERO) AS CUENTA
,IRELEASE
,IACTUALIZACION
,ICOMPILACION
FROM REGINISIS_MENSAJES
WHERE
FREGISTRO BETWEEN DATEADD(-6 MONTH TO LOCALTIMESTAMP) AND LOCALTIMESTAMP
GROUP BY ITERCERO,IRELEASE,IACTUALIZACION,ICOMPILACION,FREGISTRO
ORDER BY ITERCERO)
SELECT
ITERCERO
,'R'||IRELEASE||',A'||IACTUALIZACION||','||ICOMPILACION AS ACTUALIZACION_QUE_TIENE_CLIENTE
,ANIO
,MES
,SUM(CUENTA) AS QCONEXIONES
FROM T1		
WHERE ITERCERO NOT IN ('','810000630','900100200')
AND ITERCERO IN ('813049','3227514','3521236','4277108','5576592','5726417','6882634','6885326','7492649','7539228','7539341','9779517','9800276','10213409','10221899','10247901','11440275','11787174','12401014','13927184','14697704','15434178','15444112','16367749','16659483','17303904','17348120','17419405','17595236','17903787','18519054','19157305','20620274','21206985','22059649','22376010','23676437','23790548','23943406','24311870','24331886','24483157','25000511','25159399','25166610','25181584','28212997','29688957','30298106','30393516','30399258','30518536','32244382','32436799','33966571','34533728','34975883','37555637','37729278','37844744','39429470','39456910','40328177','40928431','43403408','43455903','43629814','43741104','43924858','49796605','50913947','50926825','52254761','52491448','52916481','53124992','63310710','63490783','63549506','63562951','66774264','70088604','70142512','70904986','71527268','71596562','71632921','71657102','72130070','73204046','75066473','75077278','75079133','75107801','76322733','77174331','79333686','79838504','80435119','84035491','88153334','91010358','91205035','92277857','92539794','92543613','94390997','94471042','98546647','98552355','98670567','301107188','700159177','800016505','800046169','800083696','800138950','800190413','800192705','800222727','800243936','800247506','801000577','801001525','801001664','801004159','804004477','804013234','804017151','805019438','810004932','811003494','811008036','811013831','811017755','811024452','811031312','811032433','811033421','811036719','811036883','811045372','812005151','814007357','817004278','829001143','829001222','830035316','830051073','830095669','830131674','830136221','830503127','830503242','832000964','832003419','832009861','835001377','860351668','860522220','890000467','890000590','890203382','890308720','890907785','890938805','890981556','891001144','891408513','891801951','892000435','900011088','900038435','900043174','900071237','900073237','900074373','900086864','900120713','900130135','900131820','900135344','900146802','900181769','900196299','900199018','900206780','900209047','900228693','900239936','900254209','900267904','900269684','900275360','900276650','900320190','900329004','900331007','900370610','900382580','900387625','900388429','900398824','900406116','900419249','900424715','900435084','900435672','900444400','900445702','900454813','900457031','900467446','900467939','900471989','900501048','900506207','900506978','900535573','900535940','900540503','900541610','900542731','900545216','900546331','900565174','900577821','900587608','900591016','900592299','900604817','900610590','900619121','900650559','900654472','900676407','900681763','900683110','900689417','900690672','900691092','900694387','900697774','900712677','900716654','900719117','900730348','900732160','900743259','900745500','900746858','900764028','900770954','900792320','900793864','900804030','900808898','900813550','900819093','900821689','900826780','900859067','900862579','900881560','900900967','900901817','900926654','900947201','900976610','901009405','901012235','901015664','901018481','901019961','901021175','901027390','901036699','901039410','901044434','901062456','901063852','901090471','901091229','901092845','901093175','901106328','901116595','901121503','901134322','901141968','901144507','901147944','901163518','901173259','901191550','901194389','901195848','901209184','901220611','901228246','901228759','901266921','901271879','901273489','901281027','901291624','901292424','901296286','901303950','901310961','901311732','901331205','901345036','901352382','901354259','901368764','901379779','901380825','901389719','901393876','901397511','901401944','901410552','901416018','901417109','901419532','901419950','901422575','901424800','901432604','901438320','901445577','901461632','901463108','901467485','901469606','901471574','901478213','901481837','901481847','901492418','901494696','901505438','901510510','901517861','901522369','901533293','901535510','901542983','901545438','901595163','901602490','901611889','901622024','901622153','901651763','901662960','901672312','901677638','901686508','901705145','901726103','901737239','901740582','901747074','901748279','901752447','901762757','901767544','901767598','901773282','901792380','901801548','901807943','901823295','901834762','901836183','901837284','901845574','901849960','901858189','901879022','901891167','901900930','1006295580','1015422304','1023866883','1026263642','1027880309','1035222121','1036629438','1036840740','1042430950','1047342506','1053586020','1053798991','1053862201','1053875885','1064313754','1071890033','1073809985','1085322815','1085906271','1088342514','1094932526','1095802994','1096952430','1097724788','1098652580','1098674123','1098782906','1102879035','1107078494','1112458526','1112761162','1116795459','1120365835','1121900314','1121910163','1121953394','1127917004','1127963246','1128421902','1140850952','1143331324','1143861085','1144044128','1151940597','0564-2018')
GROUP BY ITERCERO,ANIO,MES,IRELEASE,IACTUALIZACION,ICOMPILACION
ORDER BY ITERCERO,IRELEASE,IACTUALIZACION,ICOMPILACION,ANIO,MES		

--Query para enviar uso de CP por TERCERO y SERVIDOR en los últimos 6 meses para operaciones desagregado por release(Solicitud AALZATE)
WITH T1 AS(SELECT
ITERCERO
,GUID AS SERVIDOR
,EXTRACT(MONTH FROM FREGISTRO) AS MES
,EXTRACT(YEAR FROM FREGISTRO) AS ANIO
,COUNT(ITERCERO) AS CUENTA
,IRELEASE
,IACTUALIZACION
,ICOMPILACION
FROM REGINISIS_MENSAJES
WHERE
FREGISTRO BETWEEN DATEADD(-12 MONTH TO LOCALTIMESTAMP) AND LOCALTIMESTAMP
GROUP BY ITERCERO,IRELEASE,IACTUALIZACION,ICOMPILACION,GUID,FREGISTRO
ORDER BY ITERCERO)
SELECT
ITERCERO
,SERVIDOR
,'R'||IRELEASE||',A'||IACTUALIZACION||','||ICOMPILACION AS ACTUALIZACION_QUE_TIENE_CLIENTE
,ANIO
,MES
,SUM(CUENTA) AS QCONEXIONES
FROM T1		
WHERE ITERCERO NOT IN ('','810000630','900100200')
--Terceros de onboarding que se quiere analizar
AND ITERCERO IN ('1094924528','63355019','901843835','901233414','901545438','9730719','901638900','901508623','901026811','1016007794','1098755670','901052588','1121910163','901560487','811040462','900162387','900621476','901850152','901377852','3276449','900976610','1037655738','39357882','901806331','45689698','901519080','106730130','901851710','901873373','30319448','901707747','900549705','1065853944','901538707','890270248','900275360','28554133','901377852','900879346','901224433','1039420061','30298106','901879022','901787479','10255639','901312233','900461537','901886991','901842427','75085318','900737165','890802753','901867092','3101851998','1006295580','802021394','901836183','1095808420','901249338','900573970','901763712','901905958','1053857540','1040042183','1024516904','844001008','829000257','901841056','901534804','80928231','901307114','900683613','900812950','901509316','800139928','901377978','1013621856','900037096','14999554','1110540327','1121849963','1094887026','34533728','901888083','51921027','52770503','901355587','73582537','901904710','901447337','901026983','900662299','74370146','901506264','901816559','901148414','900774535','901483663','901571719','70826807','1143876962','1061707077','891200540','700000542','901235780','901184773','901811265','71480392','900652890','901018827','16931348','1096245855','901588453','900938699','70829525','1045021319','900543184','901224526','901901672','35427358')
GROUP BY ITERCERO,ANIO,MES,IRELEASE,IACTUALIZACION,ICOMPILACION,SERVIDOR
ORDER BY ITERCERO,SERVIDOR,IRELEASE,IACTUALIZACION,ICOMPILACION,ANIO,MES

--Cantidad de NITs distintos para un mismo nombre de área que tiene un tercero en un mismo servidor (cuando la cuenta es mayor a 5 y en el último año)
SELECT ITERCERO,GUID,NAREA,COUNT(DISTINCT INIT) AS CANTIDAD
FROM REGINISIS_GENERAL 
WHERE ITERCERO NOT IN ('04209010311343','0471006589','05019005481451','05019018063836','06141610921145','0990030251001','10025583','1017184652','1026130755','1032419881','1036638965','1053770003','10540528','1061723397','10853039589','1088267883','1088285348','1088537432','1098608797','1098635222','1102373363','11134267','1116250415','1116547360','1116773463','1121839858','1121868536','123456789','12753831','13353901','13460584','14159013596678','15431371','15961880','16234894','16359436','17629508','1803039948001','19479537','19490802','205710322','207070846','24334495','24757904','24867780','25739281829906','2961417','3-101-482590','30402491','3101433530','3102681694','31168173','32182953','34515871','36993288','40328373','40334996','4058914','41943902','43200082','4352131','43522288','43534407','43808611','43824294','43827589','4412814','46457271','51939251','52173171','52346602','5287399','5490108','5796774','59818240','6239795','63270221','63331159','63344538','63497186','700167458','70901489','71380093','71596562','71779759','7178679','71979401','75065450','75090754','7522697','7537494','7538031','77153532','78699349','79047372','79233728','79313934','79542188','79626459','79738495','800027004','800044725','800053516','800117605','800138950','800157682','800164563','800190413','800223957','8038217','804015462','805006409','805019040','810000630','810003155','810003243','810004788','811028375','811037912','822007239','826000514','830015006','830047146','830057860','830093499','830096215','830138686','830141050','830142127','830505383','86044531','890308001','890801733','890802206','890807146','899999034-1','900022318','900042580','900062453','900082642','900097159','900100200','900114642','900128995','900131199','900133191','900209047','900211678','900223793','900235906','900239079','900241604','900242107','900248718','900259508','900262946','900266837','900278754','900291748','900294380','900300136','900300392','900335377','900347762','900347967','900349793','900355893','900359988','900363831','900382350','900384945','900409858','900422335','900426008','900434374','900437270','900438204','900442500','900449440','900464953','900468745','900488836','900535016','900548752','900558366','900570444','900578808','900593853','900595482','900615864','900616214','900620664','900634677','900639526','900647979','900659285','900667578','900687606','900691364','900698805','900708074','900711893','900712075','900735316','900736604','900760433','900781032','900786656','900790547','900804795','900814129','900817537','900819806','900835023','900869770','900871537','900930612','900944415','900951977','900953063','900977016','900978268','901007553','901014028','901023993','901024797','901026705','901036660','901054945','901055923','901072403','901116990','901124011','901133030','901371003','901444416','901455552','91283210','91285160','91432403','93204466','9771396','98546647','GPR910522QW6','J0310000053979','J0310000140340','PRO_483647','TAL-091210-180','')
--AND FREGISTRO BETWEEN DATEADD(-12 MONTH TO CURRENT_DATE) AND CURRENT_DATE
GROUP BY ITERCERO,GUID,NAREA
HAVING COUNT(DISTINCT INIT)>5
ORDER BY ITERCERO,COUNT(DISTINCT INIT) DESC

--Cantidad de terceros por rango según cantidad de nits distintos que tengan en una misma área de trabajo
WITH X1 AS 
(SELECT COUNT(DISTINCT INIT) AS CANTIDAD, 
CASE 
WHEN COUNT(DISTINCT INIT)=1 THEN 'A - Una sola empresa por área de trabajo'
WHEN COUNT(DISTINCT INIT) BETWEEN 2 AND 3 THEN 'B - Entre 2 y 3 empresas por área de trabajo'
WHEN COUNT(DISTINCT INIT) BETWEEN 4 AND 10 THEN 'C- Entre 4 y 10 empresas por área de trabajo'
WHEN COUNT(DISTINCT INIT)>10 THEN 'D - Más de 10 NIT empresas por área de trabajo'
ELSE 'Revisar'
END AS CLASIFICACION
FROM REGINISIS_GENERAL 
WHERE ITERCERO NOT IN ('04209010311343','0471006589','05019005481451','05019018063836','06141610921145','0990030251001','10025583','1017184652','1026130755','1032419881','1036638965','1053770003','10540528','1061723397','10853039589','1088267883','1088285348','1088537432','1098608797','1098635222','1102373363','11134267','1116250415','1116547360','1116773463','1121839858','1121868536','123456789','12753831','13353901','13460584','14159013596678','15431371','15961880','16234894','16359436','17629508','1803039948001','19479537','19490802','205710322','207070846','24334495','24757904','24867780','25739281829906','2961417','3-101-482590','30402491','3101433530','3102681694','31168173','32182953','34515871','36993288','40328373','40334996','4058914','41943902','43200082','4352131','43522288','43534407','43808611','43824294','43827589','4412814','46457271','51939251','52173171','52346602','5287399','5490108','5796774','59818240','6239795','63270221','63331159','63344538','63497186','700167458','70901489','71380093','71596562','71779759','7178679','71979401','75065450','75090754','7522697','7537494','7538031','77153532','78699349','79047372','79233728','79313934','79542188','79626459','79738495','800027004','800044725','800053516','800117605','800138950','800157682','800164563','800190413','800223957','8038217','804015462','805006409','805019040','810000630','810003155','810003243','810004788','811028375','811037912','822007239','826000514','830015006','830047146','830057860','830093499','830096215','830138686','830141050','830142127','830505383','86044531','890308001','890801733','890802206','890807146','899999034-1','900022318','900042580','900062453','900082642','900097159','900100200','900114642','900128995','900131199','900133191','900209047','900211678','900223793','900235906','900239079','900241604','900242107','900248718','900259508','900262946','900266837','900278754','900291748','900294380','900300136','900300392','900335377','900347762','900347967','900349793','900355893','900359988','900363831','900382350','900384945','900409858','900422335','900426008','900434374','900437270','900438204','900442500','900449440','900464953','900468745','900488836','900535016','900548752','900558366','900570444','900578808','900593853','900595482','900615864','900616214','900620664','900634677','900639526','900647979','900659285','900667578','900687606','900691364','900698805','900708074','900711893','900712075','900735316','900736604','900760433','900781032','900786656','900790547','900804795','900814129','900817537','900819806','900835023','900869770','900871537','900930612','900944415','900951977','900953063','900977016','900978268','901007553','901014028','901023993','901024797','901026705','901036660','901054945','901055923','901072403','901116990','901124011','901133030','901371003','901444416','901455552','91283210','91285160','91432403','93204466','9771396','98546647','GPR910522QW6','J0310000053979','J0310000140340','PRO_483647','TAL-091210-180','')
		AND FREGISTRO BETWEEN DATEADD(-12 MONTH TO CURRENT_DATE) AND CURRENT_DATE
		GROUP BY ITERCERO,GUID,NAREA)
		SELECT X1.CLASIFICACION, COUNT(CLASIFICACION)
		FROM X1
		GROUP BY X1.CLASIFICACION
		ORDER BY X1.CLASIFICACION ASC 	
 
--Cantidad de áreas de trabajo por servidor, tercero, nombre área y rango
WITH X1 AS(
SELECT DISTINCT ITERCERO,GUID||','||NAREA AS CUENTA
FROM REGINISIS_GENERAL
WHERE FREGISTRO BETWEEN DATEADD(-6 MONTH TO LOCALTIMESTAMP) AND LOCALTIMESTAMP 
AND ITERCERO NOT IN ('04209010311343','0471006589','05019005481451','05019018063836','06141610921145','0990030251001','10025583','1017184652','1026130755','1032419881','1036638965','1053770003','10540528','1061723397','10853039589','1088267883','1088285348','1088537432','1098608797','1098635222','1102373363','11134267','1116250415','1116547360','1116773463','1121839858','1121868536','123456789','12753831','13353901','13460584','14159013596678','15431371','15961880','16234894','16359436','17629508','1803039948001','19479537','19490802','205710322','207070846','24334495','24757904','24867780','25739281829906','2961417','3-101-482590','30402491','3101433530','3102681694','31168173','32182953','34515871','36993288','40328373','40334996','4058914','41943902','43200082','4352131','43522288','43534407','43808611','43824294','43827589','4412814','46457271','51939251','52173171','52346602','5287399','5490108','5796774','59818240','6239795','63270221','63331159','63344538','63497186','700167458','70901489','71380093','71596562','71779759','7178679','71979401','75065450','75090754','7522697','7537494','7538031','77153532','78699349','79047372','79233728','79313934','79542188','79626459','79738495','800027004','800044725','800053516','800117605','800138950','800157682','800164563','800190413','800223957','8038217','804015462','805006409','805019040','810000630','810003155','810003243','810004788','811028375','811037912','822007239','826000514','830015006','830047146','830057860','830093499','830096215','830138686','830141050','830142127','830505383','86044531','890308001','890801733','890802206','890807146','899999034-1','900022318','900042580','900062453','900082642','900097159','900100200','900114642','900128995','900131199','900133191','900209047','900211678','900223793','900235906','900239079','900241604','900242107','900248718','900259508','900262946','900266837','900278754','900291748','900294380','900300136','900300392','900335377','900347762','900347967','900349793','900355893','900359988','900363831','900382350','900384945','900409858','900422335','900426008','900434374','900437270','900438204','900442500','900449440','900464953','900468745','900488836','900535016','900548752','900558366','900570444','900578808','900593853','900595482','900615864','900616214','900620664','900634677','900639526','900647979','900659285','900667578','900687606','900691364','900698805','900708074','900711893','900712075','900735316','900736604','900760433','900781032','900786656','900790547','900804795','900814129','900817537','900819806','900835023','900869770','900871537','900930612','900944415','900951977','900953063','900977016','900978268','901007553','901014028','901023993','901024797','901026705','901036660','901054945','901055923','901072403','901116990','901124011','901133030','901371003','901444416','901455552','91283210','91285160','91432403','93204466','9771396','98546647','GPR910522QW6','J0310000053979','J0310000140340','PRO_483647','TAL-091210-180','')
),X2 AS(
SELECT ITERCERO,
CASE 
	WHEN COUNT(ITERCERO)=1 THEN 'A-Terceros con un área'
WHEN COUNT(ITERCERO) BETWEEN 2 AND 3 THEN 'B-Terceros con 2 y 3 áreas'
WHEN COUNT(ITERCERO) BETWEEN 4 AND 5 THEN 'C-Terceros con 4 y 5 áreas'
WHEN COUNT(ITERCERO) BETWEEN 6 AND 7 THEN 'D-Terceros con 6 y 7 áreas'
WHEN COUNT(ITERCERO) BETWEEN 8 AND 9 THEN 'E-Terceros con 8 y 9 áreas'
WHEN COUNT(ITERCERO)=10 THEN 'F-Terceros con 10 áreas'
WHEN COUNT(ITERCERO) BETWEEN 11 AND 20 THEN 'G-Terceros entre 11 y 20 áreas'
WHEN COUNT(ITERCERO) BETWEEN 21 AND 30 THEN 'H-Terceros entre 21 y 30 áreas'	
WHEN COUNT(ITERCERO)>30 THEN 'I-Terceros con más de 30 áreas'
END AS RANGOS
,COUNT(ITERCERO) AS CantidadAreas
FROM X1
GROUP BY ITERCERO
ORDER BY ITERCERO
)
SELECT RANGOS,COUNT(RANGOS)
FROM X2
GROUP BY RANGOS
ORDER BY RANGOS ASC		

'QUERY PARA SEGUIMIENTO DE CALIDAD DE ACTUALIZACIÓN'

--SQL impacto de PQRs en producción (que tengan TK de Ing,ATE,N2 y N1) para una actualización dada
--NOTA: de este SQL no fue posible quitar los tks no anulados de X1 pues el SQL tardaría mas de 5 min. El valor no debería afectarse mucho
WITH X1 AS
(
SELECT T1.IPQR AS IPQR,COUNT(T1.IPQR) AS CUENTA
FROM SOP_PQRSPORTIQUETE T1
LEFT JOIN SOP_TIQUETES T2 ON T1.IPQR=T2.ITIQUETE
LEFT JOIN SOP_TEMAS T3 ON T2.ITEMA=T3.ITEMA
--WHERE T2.BANULADO='F'
--AND T2.IACTUALIZACION=:ACTUALIZACION
--AND T2.IBUILD=:COMPILADO
GROUP BY T1.IPQR
ORDER BY T1.IPQR DESC
)
SELECT T3.NTEMA,CASE WHEN CHAR_LENGTH(T1.IBUILD) = 1 THEN 'A'||T1.IACTUALIZACION||',0' || T1.IBUILD ELSE 'A'||T1.IACTUALIZACION||',' || T1.IBUILD END AS ACTUALIZACION,T1.ASIGNADOA,T1.ABIERTOPOR AS CREADOPOR,T1.ITIQUETE AS PQR_ING,T1.ITIQUETEREF AS TK_AT,T2.ITIQUETEREF AS TK_N2,X1.CUENTA AS USUARIOSIMPACTADOS
FROM SOP_TIQUETES T1
LEFT JOIN SOP_TIQUETES T2 ON T1.ITIQUETEREF=T2.ITIQUETE
LEFT JOIN X1 ON T2.ITIQUETEREF=X1.IPQR
LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA --Se une para traer el nombre del tema
LEFT JOIN ABADTIT T6 ON T6.ITABLA='ITDSOLICITUDC' AND T1.ITDSOLICITUD=T6.ITITULO --Se une para traer tipo de solicitud de cierre
WHERE 
T1.ASIGNADOA IN ('DOCAMPO','ESUAREZ','PRENDON','DHURTADO') 
AND T1.BANULADO='F'
AND T2.BANULADO='F'
--AND T1.ITIQUETEREF IS NOT NULL
--AND T2.ITIQUETEREF IS NOT NULL
AND T1.IACTUALIZACION IN :ACTUALIZACION
--AND T1.IBUILD IN :COMPILADO	
AND T3.NTEMA LIKE '%Sop Ing%' --Solo se tienen en cuenta PQRs cuyo tema contenga Sop Ing
AND T1.IMOTIVO=0 -- 0 para PQRs de producción
AND T6.NTITULO IN ('C - Error del sistema','PQR Error del sistema','1 - PQR - Error del sistema','1- PQR - Error del sistema (causa no identificada)','1 - PQR - Error por cambio anterior (para uso AT e ING únicamente)','1 - PQR - Error del sistema (causa no identificada)','1 - PQR - Error por caso nuevo (para uso AT e ING únicamente)','1 - PQR - Error por normativa (para uso AT e ING únicamente)')
--AND T1.ITIQUETE=1268248 
ORDER BY X1.CUENTA DESC

--SQL impacto de PQRs en producción (que tengan TK de Ing,ATE,N2 y N1) para un mes y año dados
--NOTA: de este SQL no fue posible quitar los tks no anulados de X1 pues el SQL tardaría mas de 5 min. El valor no debería afectarse mucho
WITH X1 AS
(
SELECT T1.IPQR AS IPQR,COUNT(T1.IPQR) AS CUENTA
FROM SOP_PQRSPORTIQUETE T1
GROUP BY T1.IPQR
ORDER BY T1.IPQR DESC
)
SELECT T3.NTEMA,T6.NTITULO,T1.ITIQUETE AS PQR_ING,T1.ITIQUETEREF AS TK_AT,T2.ITIQUETEREF AS TK_N2,X1.CUENTA AS USUARIOSIMPACTADOS
FROM SOP_TIQUETES T1
LEFT JOIN SOP_TIQUETES T2 ON T1.ITIQUETEREF=T2.ITIQUETE
LEFT JOIN X1 ON T2.ITIQUETEREF=X1.IPQR
LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA --Se une para traer el nombre del tema
LEFT JOIN ABADTIT T6 ON T6.ITABLA='ITDSOLICITUDC' AND T1.ITDSOLICITUD=T6.ITITULO --Se une para traer tipo de solicitud de cierre
WHERE 
T1.ASIGNADOA IN ('DOCAMPO','ESUAREZ','PRENDON','DHURTADO') 
AND T1.BANULADO='F'
AND T2.BANULADO='F'
--AND T1.ITIQUETEREF IS NOT NULL
--AND T2.ITIQUETEREF IS NOT NULL
AND EXTRACT(MONTH FROM T1.FHSOLUCIONADO)=:MES
AND EXTRACT(YEAR FROM T1.FHSOLUCIONADO)=:ANIO
AND T3.NTEMA LIKE '%Sop Ing%' --Solo se tienen en cuenta PQRs cuyo tema contenga Sop Ing
AND T1.IMOTIVO=0 -- 0 para PQRs de producción
AND T6.NTITULO IN ('C - Error del sistema','PQR Error del sistema','1 - PQR - Error del sistema','1- PQR - Error del sistema (causa no identificada)','1 - PQR - Error por cambio anterior (para uso AT e ING únicamente)','1 - PQR - Error del sistema (causa no identificada)','1 - PQR - Error por caso nuevo (para uso AT e ING únicamente)','1 - PQR - Error por normativa (para uso AT e ING únicamente)')
ORDER BY X1.CUENTA DESC		

--SQL cantidad de PQRs para una actualización dada (se retorna IPQR y cantidad que aparece ese IPQR para una actualización dada)
		--Interpretación: el TK de N2 puede estar en una actualización anterior pero desde N1 haber documentado el TK con la nueva actualización
		--Ejemplo: TKN2 reportado en R8.23.40 se libero R8.23.50 y el N1 marca este nuevo TK con la actualización más reciente lo cual es incorrecto
SELECT T2.IPQR AS TK_N2
,T4.NTEMA
, 'A'||T3.IACTUALIZACION||','||T3.IBUILD
,COUNT(T2.IPQR)AS Cantidad
FROM SOP_TIQUETES T1
LEFT JOIN SOP_PQRSPORTIQUETE T2 ON T1.ITIQUETE=T2.ITIQUETE
LEFT JOIN SOP_TIQUETES T3 ON T2.IPQR=T3.ITIQUETE
LEFT JOIN SOP_TEMAS T4 ON T3.ITEMA=T4.ITEMA
WHERE 
T1.BANULADO='F'
AND T1.IACTUALIZACION IN :ACTUALIZACION 
--AND T1.IBUILD IN :COMPILADO
--AND T2.IPQR=1259777
GROUP BY T2.IPQR,T3.IACTUALIZACION,T3.IBUILD,T4.NTEMA
HAVING COUNT(T2.IPQR)>1
ORDER BY COUNT(T2.IPQR) DESC	
	
-- SQL tasa de reproceso por mes	
SELECT 
T1.ASIGNADOA AS INGENIERO
--,EXTRACT(MONTH FROM T1.FHSOLUCIONADO) AS MES
,SUM(CASE WHEN T6.ITITULO='199'THEN 1 END) AS Q_ERROR_CAMBIO_ANTERIOR
,COUNT(*) AS Q_PQRS
,(CAST(SUM(CASE WHEN T6.ITITULO='199'THEN 1 END) AS DECIMAL(10,2))/COUNT(*)*100)||'%' AS PERCENT
FROM SOP_TIQUETES T1
LEFT JOIN ABADTIT T6 ON T6.ITABLA='ITDSOLICITUDC' AND T1.ITDSOLICITUD=T6.ITITULO
LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA
WHERE EXTRACT (YEAR FROM T1.FHSOLUCIONADO)=:ANIO
AND EXTRACT (MONTH FROM T1.FHSOLUCIONADO) IN :MES
AND T1.ASIGNADOA IN ('DOCAMPO','PRENDON','ESUAREZ','DHURTADO')
AND T3.NTEMA LIKE '%Sop Ing%'
GROUP BY T1.ASIGNADOA--,T1.FHSOLUCIONADO
ORDER BY T1.ASIGNADOA--,T1.FHSOLUCIONADO	

--Para consultar el detalle de la consulta anterior (SQL cantidad de PQRs para una actualización dada)
SELECT T2.ITIQUETE,T1.IACTUALIZACION||','||T1.IBUILD AS AN1_DETECTA_EN,T1.FHAPERTURA,T1.FHSOLUCIONADO 
FROM SOP_PQRSPORTIQUETE T2
LEFT JOIN SOP_TIQUETES T1 ON T2.ITIQUETE=T1.ITIQUETE 
WHERE T2.IPQR = 1132791 --reemplazar el IPQR por el que se quiere analizar
AND T1.BANULADO='F'
ORDER BY T2.ITIQUETE DESC,T1.IACTUALIZACION||','||T1.IBUILD DESC	

--Para calcular la tasa de error por módulo y actualización (cuando error es por cambio anterior)
WITH X1 AS
(
SELECT T1.ASIGNADOA AS ASIGNADOA,T2.NTEMA AS NTEMA,COUNT(*) AS TOTAL
FROM SOP_TIQUETES T1
LEFT JOIN SOP_TEMAS T2 ON T1.ITEMA=T2.ITEMA
LEFT JOIN ABADTIT T3 ON T3.ITABLA='ITDSOLICITUDC' AND T1.ITDSOLICITUD=T3.ITITULO
WHERE 
T1.BANULADO='F'
AND T1.ASIGNADOA IN ('ESUAREZ', 'DOCAMPO', 'PRENDON','DHURTADO')
AND T1.IACTUALIZACION>=:ACTUALIZACION
--AND T1.IBUILD IN :COMPILADO
AND T3.NTITULO NOT IN ('1 - PQR - Adición o mejora rechazada','1 - PQR - Adición o mejora aprobada','1 - PQR - proyecto (para uso AT e ING únicamente)','1 - PQR Cambio normativo','1 - PQR - Requerimiento técnico (para uso AT e ING únicamente)','')
GROUP BY T2.NTEMA,T1.ASIGNADOA
)
SELECT *
FROM(
SELECT T1.ASIGNADOA,T2.NTEMA,COUNT(*) AS Q_ERROR_CAMBIO_ANTERIOR,X1.TOTAL AS Q_PQRS,COUNT(*)/CAST(X1.TOTAL AS DECIMAL (15,2))*100 AS PORCENTAJE
FROM SOP_TIQUETES T1
LEFT JOIN SOP_TEMAS T2 ON T1.ITEMA=T2.ITEMA
LEFT JOIN ABADTIT T3 ON T3.ITABLA='ITDSOLICITUDC' AND T1.ITDSOLICITUD=T3.ITITULO 
LEFT JOIN X1 ON T2.NTEMA=X1.NTEMA AND T1.ASIGNADOA=X1.ASIGNADOA
WHERE 
T1.BANULADO='F'
AND T1.ASIGNADOA IN ('ESUAREZ', 'DOCAMPO', 'PRENDON','DHURTADO')
AND T1.IACTUALIZACION>=:ACTUALIZACION
--AND T1.IBUILD IN :COMPILADO
AND T3.NTITULO= '1 - PQR - Error por cambio anterior (para uso AT e ING únicamente)'
GROUP BY T2.NTEMA,X1.TOTAL,T1.ASIGNADOA
)
ORDER BY ASIGNADOA,Q_ERROR_CAMBIO_ANTERIOR DESC

--Q Terceros en cada compilado a partir de una actualización dada
WITH X1 AS (
SELECT DISTINCT 
T1.ITERCERO
,T1.IACTUALIZACION AS ACTUALIZACION
,T1.ICOMPILACION AS COMPILADO
,CASE WHEN T2.IEMPPROPIETARIO = '810000630' THEN 'Insoft' ELSE 'Distri' END AS Propietario
FROM REGINISIS_MENSAJES T1
LEFT JOIN TERCEROS T2 ON T1.ITERCERO=T2.ITERCERO 
WHERE 
T1.IRELEASE=8
AND T1.ICOMPILACION>=0
AND T1.IACTUALIZACION>=:ACTUALIZACION 
--AND T1.ICOMPILACION in :COMPILACION
AND T1.ITERCERO NOT IN('810000630','900100200','75070023','DEMO-CONTAPYME','DEMO-AGROWIN','63346842','')
)
SELECT *
FROM(
SELECT 
CASE 
WHEN CHAR_LENGTH(X1.COMPILADO)=1 THEN 'A'||''||X1.ACTUALIZACION||',0'||X1.COMPILADO
ELSE 'A'||''||X1.ACTUALIZACION||','||X1.COMPILADO
END AS ACTU
,COUNT(CASE WHEN X1.Propietario='Distri' THEN 1 END) AS ACTUALIZADOS_DIS
,COUNT(CASE WHEN X1.Propietario='Insoft' THEN 1 END) AS ACTUALIZADOS_IS
,COUNT(X1.Propietario) AS ACTUALIZADOS_TOTALES
FROM X1
GROUP BY X1.ACTUALIZACION,X1.COMPILADO
)
ORDER BY ACTU DESC

--Q Terceros en cada compilado a partir de una actualización dada y según actu máxima a la que ha llegado un tercero
WITH X1 AS (
SELECT DISTINCT 
T1.ITERCERO
,MAX(CASE 
WHEN CHAR_LENGTH(T1.ICOMPILACION)=1 THEN 'A'||''||T1.IACTUALIZACION||',0'||T1.ICOMPILACION
ELSE 'A'||''||T1.IACTUALIZACION||','||T1.ICOMPILACION
END) AS ACTU
,CASE WHEN T2.IEMPPROPIETARIO = '810000630' THEN 'Insoft' ELSE 'Distri' END AS Propietario
FROM REGINISIS_MENSAJES T1
LEFT JOIN TERCEROS T2 ON T1.ITERCERO=T2.ITERCERO 
WHERE 
T1.IRELEASE=8
AND T1.ICOMPILACION>=0
AND T1.IACTUALIZACION>=:ACTUALIZACION 
--AND T1.ICOMPILACION in :COMPILACION
AND T1.ITERCERO NOT IN('810000630','900100200','75070023','DEMO-CONTAPYME','DEMO-AGROWIN','63346842','')
GROUP BY T1.ITERCERO,T2.IEMPPROPIETARIO
)
SELECT *
FROM(
SELECT 
X1.ACTU
,COUNT(CASE WHEN X1.Propietario='Distri' THEN 1 END) AS ACTUALIZADOS_DIS
,COUNT(CASE WHEN X1.Propietario='Insoft' THEN 1 END) AS ACTUALIZADOS_IS
,COUNT(X1.Propietario) AS ACTUALIZADOS_TOTALES
FROM X1
GROUP BY X1.ACTU
)
ORDER BY ACTU DESC
		
--Q Terceros en cada compilado a partir de una actualización dada y según actu máxima a la que ha llegado un tercero y que tengan póliza vigente
WITH X1 AS (
SELECT DISTINCT 
T1.ITERCERO
,MAX(CASE 
WHEN CHAR_LENGTH(T1.ICOMPILACION)=1 THEN 'A'||''||T1.IACTUALIZACION||',0'||T1.ICOMPILACION
ELSE 'A'||''||T1.IACTUALIZACION||','||T1.ICOMPILACION
END) AS ACTU
,CASE WHEN T2.IEMPPROPIETARIO = '810000630' THEN 'Insoft' ELSE 'Distri' END AS Propietario
FROM REGINISIS_MENSAJES T1
LEFT JOIN TERCEROS T2 ON T1.ITERCERO=T2.ITERCERO 
WHERE 
T1.IRELEASE=8
AND T1.ICOMPILACION>=0
AND T1.IACTUALIZACION>=:ACTUALIZACION 
--AND T1.ICOMPILACION in :COMPILACION
AND T1.ITERCERO NOT IN('810000630','900100200','75070023','DEMO-CONTAPYME','DEMO-AGROWIN','63346842','')
--AND EXISTS falta incluir póliza
GROUP BY T1.ITERCERO,T2.IEMPPROPIETARIO
)
SELECT *
FROM(
SELECT 
X1.ACTU
,COUNT(CASE WHEN X1.Propietario='Distri' THEN 1 END) AS ACTUALIZADOS_DIS
,COUNT(CASE WHEN X1.Propietario='Insoft' THEN 1 END) AS ACTUALIZADOS_IS
,COUNT(X1.Propietario) AS ACTUALIZADOS_TOTALES
FROM X1
GROUP BY X1.ACTU
)
ORDER BY ACTU DESC
	
--Q Terceros diferentes en una actualización dada y por propietario
WITH X1 AS(
SELECT DISTINCT T1.ITERCERO,CASE WHEN T2.IEMPPROPIETARIO = '810000630' THEN 'Insoft' ELSE 'Distri' END AS Propietario
FROM REGINISIS_MENSAJES T1
LEFT JOIN TERCEROS T2 ON T1.ITERCERO=T2.ITERCERO
WHERE T1.IRELEASE = 8 AND T1.IACTUALIZACION IN :IACTUALIZACION AND T1.ICOMPILACION IN :ICOMPILADO
AND T1.ITERCERO NOT IN ('810000630','900100200','75070023','DEMO-CONTAPYME','DEMO-AGROWIN','63346842','')		
)
SELECT
COUNT(CASE WHEN X1.Propietario='Distri' THEN 1 END) AS ACTUALIZADOS_DIS
,COUNT(CASE WHEN X1.Propietario='Insoft' THEN 1 END) AS ACTUALIZADOS_IS
,COUNT(X1.Propietario) AS ACTUALIZADOS_TOTALES
FROM X1

--Terceros diferentes en una actualización dada
SELECT DISTINCT ITERCERO
FROM REGINISIS_MENSAJES
WHERE IRELEASE = 8 AND IACTUALIZACION IN :IACTUALIZACION AND ICOMPILACION=10
and ITERCERO NOT IN ('810000630','900100200','75070023','DEMO-CONTAPYME','DEMO-AGROWIN','63346842','')

--Query para identificar la cantidad de terceros actualizados por día para cada una de las actualizaciones	
WITH X1 AS(
SELECT DISTINCT 
T1.ITERCERO
,IVERSION
,IRELEASE
,IACTUALIZACION
,ICOMPILACION,
'R'||IRELEASE||'.A'||IACTUALIZACION||'.'||ICOMPILACION AS CONCATENADO,
MIN(CAST(FREGISTRO AS DATE)) AS FECHA,
CASE WHEN T2.IEMPPROPIETARIO='810000630' THEN 'Insoft' ELSE 'Distri' END AS Propietario
FROM REGINISIS_MENSAJES T1
LEFT JOIN TERCEROS T2 ON T1.ITERCERO=T2.ITERCERO
WHERE IRELEASE>7 AND IACTUALIZACION>=24 AND ICOMPILACION>=0 AND FREGISTRO>'2023-12-31' AND T1.ITERCERO NOT IN ('810000630','900100200','75070023','DEMO-CONTAPYME','DEMO-AGROWIN','63346842','')
GROUP BY T1.ITERCERO, IVERSION,IRELEASE,IACTUALIZACION,ICOMPILACION,T2.IEMPPROPIETARIO)
SELECT  
RANK() OVER (PARTITION BY X1.CONCATENADO ORDER BY X1.FECHA)-1,
X1.CONCATENADO
,X1.IVERSION
,X1.IRELEASE
,X1.IACTUALIZACION
,X1.ICOMPILACION AS IBUILD
,X1.FECHA
,CASE EXTRACT(WEEKDAY FROM X1.FECHA)
    WHEN 0 THEN 'Domingo'
WHEN 1 THEN 'Lunes'
WHEN 2 THEN 'Martes'
WHEN 3 THEN 'Miércoles'
WHEN 4 THEN 'Jueves'
WHEN 5 THEN 'Viernes'
WHEN 6 THEN 'Sábado'
END AS DayName
,COUNT(X1.ITERCERO)
,COUNT(CASE WHEN X1.Propietario='Distri' THEN 1 END) AS ACTUALIZADOS_DIS
,COUNT(CASE WHEN X1.Propietario='Insoft' THEN 1 END) AS ACTUALIZADOS_IS
FROM X1 	
WHERE EXTRACT(WEEKDAY FROM X1.FECHA) NOT IN (0,6)
GROUP BY X1.CONCATENADO,X1.FECHA,X1.IVERSION,X1.IRELEASE,X1.IACTUALIZACION,X1.ICOMPILACION
ORDER BY X1.CONCATENADO,X1.FECHA

--Terceros con póliza vigente
SELECT 
ITERCERO
,MIN(FFINPOLIZA) AS FVENCIMIENTO
FROM MOVSOLICITUDPOLIZAS
WHERE (IAUTORIZACION = 1)
AND (FFINPOLIZA >= LOCALTIMESTAMP)
--AND ITERCERO IN ()
GROUP BY ITERCERO,IPOLIZA
HAVING SUM(IESTADO) > 0	

--Comunidad activa (Q clientes que registran inicios del sistema en un mes dado)
WITH X1 AS
(
SELECT 
DISTINCT ITERCERO
,EXTRACT (YEAR FROM FREGISTRO) AS ANIO
,EXTRACT(MONTH FROM FREGISTRO) AS MES
FROM REGINISIS_MENSAJES
WHERE ITERCERO NOT IN ('900100200','810000630','DEMO-CONTAPYME','DEMO-AGROWIN')
ORDER BY ITERCERO
)
SELECT X1.ANIO,X1.MES,COUNT(X1.ANIO||','||X1.MES)
FROM X1
GROUP BY X1.ANIO,X1.MES
ORDER BY X1.ANIO DESC,X1.MES DESC

--SELECT DISTINCT COUNT(DISTINCT ITERCERO)
--FROM REGINISIS_MENSAJES
--WHERE 
--EXTRACT(MONTH FROM FREGISTRO)=:MES
--AND EXTRACT (YEAR FROM FREGISTRO)=:ANIO
--AND ITERCERO NOT IN ('900100200','810000630','DEMO-CONTAPYME','DEMO-AGROWIN')

	
'QUERYS PARA MEJORAS'
--Query estado mejoras en ATE por especialista y estado (zoom de Query cantidad estado mejoras en ATE)
WITH X1 AS(
SELECT *
FROM(
SELECT
T1.ITIQUETE,
T1.ASIGNADOA,
T5.NTITULO AS TIPO_SOLICITUD_APERTURA,
T6.NTITULO AS TIPO_SOLICITUD_CIERRE,
T7.NTITULO AS ESTADODESOLICITUD,
TRIM(CASE
	WHEN T6.NTITULO NOT IN ('1 - PQR - Adición o mejora aprobada','1 - PQR - Adición o mejora rechazada')THEN 'No era mejora'
	WHEN T1.FHCIERRE IS NOT NULL AND T6.NTITULO='1 - PQR - Adición o mejora aprobada' THEN 'A-Entregada'
	WHEN T1.FHCIERRE IS NOT NULL AND T6.NTITULO='1 - PQR - Adición o mejora rechazada' THEN 'B-Rechazada'
	WHEN T1.FHSOLUCIONADO IS NOT NULL AND T6.NTITULO='1 - PQR - Adición o mejora aprobada' THEN 'C-Pendiente por entregar'
	WHEN T1.FHSOLUCIONADO IS NOT NULL AND T6.NTITULO='1 - PQR - Adición o mejora rechazada' THEN 'B-Rechazada'
	WHEN T1.FHATENDIDO IS NOT NULL AND T1.BPQR='T' THEN 'D-Sin solucionar y escaladas'
	WHEN T1.FHATENDIDO IS NOT NULL AND T1.BPQR='F' THEN 'E-Sin escalar atendidas'
	WHEN T1.FHATENDIDO IS NULL AND T7.NTITULO='1 - En espera de comité de Ingeniería' THEN 'F-Sin atender y estado espera de comité'
	WHEN T1.FHATENDIDO IS NULL THEN 'G-Sin atender y sin estado'			
	ELSE 'REVISAR'
	--WHEN T1.FHATENDIDO IS NOT NULL THEN 'Atendido'
END) AS CLASIFICACION
FROM SOP_TIQUETES T1
LEFT JOIN ABADTIT T5 ON T5.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T5.ITITULO --tipo solicitud de apertura
LEFT JOIN ABADTIT T6 ON T6.ITABLA='ITDSOLICITUDC' AND T1.ITDSOLICITUD=T6.ITITULO --tipo solicitud cierre
LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA = T7.ITITULO
WHERE
T1.BANULADO='F'
AND T5.NTITULO IN ('1 - PQR mejora','A - PQR adición o mejora')
AND T1.ASIGNADOA IN('ATORO','ACESPEDES','VRESTREPO','AGIL','TLEON','SALARCON')
AND T1.FHAPERTURA >='2023-01-01')
ORDER BY CLASIFICACION
)
SELECT X1.ITIQUETE,X1.ASIGNADOA,X1.CLASIFICACION
FROM X1
WHERE X1.CLASIFICACION IN ('D-Sin solucionar y escaladas','E-Sin escalar atendidas','F-Sin atender y estado espera de comité','G-Sin atender y sin estado')
ORDER BY X1.ASIGNADOA,X1.CLASIFICACION		

--Query para tiempo de dedicación de mejoras PARA ATE e ING
SELECT T1.ITIQUETE,
CASE
	WHEN T3.NTEMA LIKE 'Sop Ing - %' THEN REPLACE(T3.NTEMA,'Sop Ing - ','')
	WHEN T3.NTEMA LIKE 'Sop AT - %' THEN REPLACE(T3.NTEMA,'Sop AT - ','')
	ELSE T3.NTEMA
END
,REPLACE(CAST(T1.QDEDICACION/60.00 AS VARCHAR(18)),'.',',') AS HORASDEDICACION
,T1.ASIGNADOA
FROM SOP_TIQUETES T1
LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA
WHERE T1.ITIQUETE IN (1144582,1144796,1152383,1154163,1155110,1155111,1155112,1155113,1155114,1155115,1155116,1155117,1155118,1155119,1155120,1155124,1155127,1155128,1155130,1155131,1155132,1155133,1155134,1155136,1156989,1156997,1157001,1157005,1157327,1157347,1159348,1159357,1159359,1159368,1159371,1160367,1160385,1162181,1171853,1176888,1167466,1168672,1168686,1168706,1168711,1168711,1171863,1173041,1173972,1174475,1176885,1155121,1155122,1155123,1155129,1157350,1160375,1162182,1162188,1197705,1197707,1197708,1184800,1197709,1197711,1197732,1205323,1209434,1162179,1162183,1162189,1197710,1197731,1220061,1207001,1207008,1223803,1162184,1245245,1235821,1197734,1157345,1162187,1245252,1250815,1155135,1197706,1197704,1155125,1162185,1162186,1230535,1230539,1238306,1238309,1238311,1238312,1245402,1245409,1245414,1245415)
AND FHSOLUCIONADO IS DISTINCT FROM NULL

--Oportunidad de mejoras (basado en cierre TKs de Ing)	
WITH X1 AS
(
SELECT
T1.ITIQUETE,
CASE
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) IN (1,4,7,10) THEN '1'
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) IN (2,5,8,11) THEN '2'	
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) IN (3,6,9,12) THEN '3'	
END AS MES_TRIMESTRE,
CASE
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) BETWEEN 1 AND 3 THEN 'Q1'
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) BETWEEN 4 AND 6 THEN 'Q2'
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) BETWEEN 7 AND 9 THEN 'Q3'
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) BETWEEN 10 AND 12 THEN 'Q4'	
END AS Q_CIERRE,
EXTRACT(YEAR FROM T1.FHCIERRE) AS ANIO_CIERRE,
CASE
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) BETWEEN 1 AND 3 THEN EXTRACT(YEAR FROM T1.FHCIERRE)||'Q1'
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) BETWEEN 4 AND 6 THEN EXTRACT(YEAR FROM T1.FHCIERRE)||'Q2'
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) BETWEEN 7 AND 9 THEN EXTRACT(YEAR FROM T1.FHCIERRE)||'Q3'
	WHEN EXTRACT(MONTH FROM T1.FHCIERRE) BETWEEN 10 AND 12 THEN EXTRACT(YEAR FROM T1.FHCIERRE)||'Q4'	
END AS QyANIO_CIERRE
FROM SOP_TIQUETES T1
WHERE 
T1.ITIQUETE IN (1139124,1139065,1144969,1146691,1151343,1037619,1128042,1052033,1059233,1074414,1096017,1146013,1147474,1147483,1149618,1147671,1145327,1151696,1151386,1150873,1153871,1153931,1153915,1153896,1146837,1154941,1118076,1147298,1149742,1141361,943039,1147474,1147474,1147474,1128042,1153931,1147662,1157765,1157739,1166370,1163105,1166977,1162576,1163107,1163119,1168079,1168093,1151734,1162276,1173837,1157346,1164477,1160774,1146017,1146016,1134225,1151757,1157337,1146760,1037632,1151127,1141711,1163114,1163122,1182414,1171714,1185435,1190642,1184688,1167530,865179,865176,1146713,1184644,1187126,1219833,1149415,1204078,1202841,942794,1139963,1191363,1101515,969358,1241804,1246293,1081791,1144975,945062,827655,922402,943862,945975,1227364,1228350,1229910,1229940,1229959,1229966,1226207,1226124,1226160,1244935,1250800,1245206,1253781,1251665,1248083,1255796,1262548,1262555,1263120,1271206,1271171,1268146,1052051,1080127,1080129,1131139,1269109,1272339,1271197,1271162,1271389,1271133,1271124,1258024,1275414,1274781,1273816,1273808,1273719,1275775,1275829)
AND T1.BANULADO='F' 
AND T1.FHCIERRE IS NOT NULL
)
SELECT X1.ITIQUETE,X1.MES_TRIMESTRE AS Mes_Cierre,X1.Q_CIERRE,X1.ANIO_CIERRE,X1.QyANIO_CIERRE AS Q_ANIO_CIERRE--,COUNT(X1.MES_TRIMESTRE||''||X1.QyANIO_CIERRE) AS CANTIDAD
FROM X1

--Tiempo de atención, solución y cierre de mejoras cerradas en un mes y año dado para Ingeniería
SELECT
T1.ASIGNADOA AS INGENIERO,
COUNT(T1.ITIQUETE) AS CANTIDAD,
REPLACE(CAST(AVG(T1.QMINATENCIONEMPRESA)/60.00 AS VARCHAR(20)),'.',',') AS PROMEDIOATENCION,
REPLACE(CAST(AVG(T1.QMINSOLUCIONEMPRESA)/60.00 AS VARCHAR(20)),'.',',') AS PROMEDIOSOLUCION,
REPLACE(CAST(AVG(T1.QMINCIERREEMPRESA)/60.00 AS VARCHAR(20)),'.',',') AS PROMEDIOCIERRE
FROM SOP_TIQUETES T1
LEFT JOIN ABADTIT T6 ON T6.ITABLA = 'ITDSOLICITUDC' AND T1.ITDSOLICITUD = T6.ITITULO
WHERE
T1.BANULADO = 'F'
AND EXTRACT(MONTH FROM T1.FHCIERRE) IN :MES --SE EVALÚA RESPECTO A MES DE SOLUCIÓN
AND EXTRACT(YEAR FROM T1.FHCIERRE) >= :ANIO --SE EVALÚA RESPECTO A MES DE SOLUCIÓN
AND T1.ASIGNADOA IN ('ESUAREZ', 'DOCAMPO', 'PRENDON','DHURTADO') --SOLO ASIGNADO A LOS ING SENIOR
AND T6.NTITULO IN ('1 - PQR - Adición o mejora aprobada','1 - PQR Ajuste del sistema') -- Se quitan los tipos de solicitud de cierre que NO aplican para tiempos
AND T1.FHCIERRE IS DISTINCT FROM NULL
AND T1.ITEMA NOT IN ('ING-32') --Se suprimen los TKs de ADD-IN al ser internos
AND EXTRACT(YEAR FROM T1.FHAPERTURA)=2025 
GROUP BY T1.ASIGNADOA
ORDER BY T1.ASIGNADOA ASC

'QUERYS PARA CALIDAD DE TKS'
	
--Para auditar la cantidad de TKs que hayan sido reasignados más de 2 veces
		SELECT T1.ITIQUETE,COUNT(T2.NACCION) 
		FROM SOP_TIQUETES T1
		LEFT JOIN SOP_BITACORATIQUETE T2 ON T1.ITIQUETE=T2.ITIQUETE 
		WHERE T2.NACCION='REASIGNACION' AND T1.ASIGNADOA IN ('ESUAREZ') AND T2.FHBITACORA>'2024-10-04'
		GROUP BY T1.ITIQUETE
		HAVING COUNT(T2.NACCION) >1
		ORDER BY T1.ITIQUETE DESC		
		

'QUERY PARA ANÁLISIS DE USO DE CP DE LOS CLIENTES'

--Cantidad de operaciones emitidas en promedio por mes por tercero
WITH X1 AS (
SELECT T2.ITERCERO AS ITERCERO,T2.GUID AS GUID,T2.NAREA AS NAREA,T1.ITDOPER AS ITDOPER,T1.QPROMEDIO AS QPROMEDIO,T2.FREGISTRO AS FREGISTRO,RANK() OVER (PARTITION BY T2.ITERCERO,T2.GUID,T2.NAREA,T1.ITDOPER ORDER BY T2.FREGISTRO DESC) AS RANGO
FROM REGINISIS_PROMOPR T1
LEFT JOIN REGINISIS_GENERAL T2 ON T1.IREGISTRO=T2.IREGISTRO
WHERE ITERCERO IS NOT NULL AND ITERCERO NOT IN ('','810000630','900100200')
GROUP BY T2.ITERCERO,T1.ITDOPER,T2.GUID,T2.NAREA,T1.QPROMEDIO,T2.FREGISTRO
ORDER BY T2.ITERCERO,T2.GUID,T2.NAREA,T1.ITDOPER	
)
SELECT X1.ITERCERO,X1.GUID,X1.NAREA,X1.ITDOPER,X1.QPROMEDIO AS PROM_USO
FROM X1
WHERE 
X1.RANGO=1 AND 
X1.QPROMEDIO>0
--AND ITERCERO=''

--Query para analizar la cantidad de terceros que usan nómina plus
WITH X1 AS (
SELECT T2.ITERCERO AS ITERCERO,T1.ITDOPER, MAX(T1.QPROMEDIO) AS MAXIMO
FROM REGINISIS_PROMOPR T1
LEFT JOIN REGINISIS_GENERAL T2 ON T1.IREGISTRO=T2.IREGISTRO
WHERE T1.ITDOPER IN ('PLA8','PLN1','PLN2') AND T2.ITERCERO IS NOT NULL AND T1.QPROMEDIO>0
GROUP BY T2.ITERCERO,T1.ITDOPER)
SELECT 
CASE 
	WHEN X1.ITDOPER ='PLA8' THEN 'PILA'
WHEN X1.ITDOPER ='PLN1' THEN 'Planilla de Reporte'
WHEN X1.ITDOPER ='PLN2' THEN 'Planilla de Pago'
ELSE 'REVISAR'
END AS OPERACION
,COUNT(MAXIMO) AS CANTIDAD
FROM X1
GROUP BY X1.ITDOPER

--Query para cantidad promedio de operaciones por mes y cantidad de áreas analizadas para calcular el dato
WITH X1 AS
(
SELECT 
RANK() OVER (PARTITION BY T2.ITERCERO,T2.GUID,T2.NAREA,T1.ITDOPER,T2.INIT ORDER BY T2.FREGISTRO DESC) AS RANGO
,T2.FREGISTRO
,T2.ITERCERO
,T2.GUID
,T2.NAREA
,T1.ITDOPER AS OPERACION
,T2.INIT
,T1.QPROMEDIO AS PROMEDIO
FROM REGINISIS_PROMOPR T1
LEFT JOIN REGINISIS_GENERAL T2 ON T1.IREGISTRO=T2.IREGISTRO
WHERE  
T2.ITERCERO IS NOT NULL 
AND T2.ITERCERO NOT IN ('810000630','900100200')
--AND T1.ITDOPER='ING5' --Si se quiere filtrar por un tipo de operación particular
AND T1.QPROMEDIO >30
)
SELECT *
FROM
(SELECT OPERACION,COUNT(RANGO) AS TERCEROS_ANALIZADOS,AVG(PROMEDIO) AS PROMEDIO_USO_MES
FROM X1
WHERE RANGO=1
GROUP BY OPERACION)
ORDER BY PROMEDIO_USO_MES DESC

--Query para cantidad promedio de operaciones por mes y cantidad de áreas analizadas para calcular el dato según rango de emisión (<1000, 1000 y 2000 , etc)
WITH X1 AS
(
SELECT 
RANK() OVER (PARTITION BY T2.ITERCERO,T2.GUID,T2.NAREA,T1.ITDOPER,T2.INIT ORDER BY T2.FREGISTRO DESC) AS RANGO
,T2.FREGISTRO
,T2.ITERCERO
,T2.GUID
,T2.NAREA
,T1.ITDOPER AS OPERACION
,T2.INIT
,T1.QPROMEDIO AS PROMEDIO
,CASE 
	WHEN T1.QPROMEDIO <=4 THEN 'Emite menos de 4 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 5 AND 10 THEN 'Emite entre 5 y 10 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 11 AND 25 THEN 'Emite entre 11 y 25 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 26 AND 50 THEN 'Emite entre 26 y 50 operaciones al mes'			
WHEN T1.QPROMEDIO BETWEEN 51 AND 125 THEN 'Emite entre 51 y 125 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 126 AND 250 THEN 'Emite entre 126 y 250 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 251 AND 500 THEN 'Emite entre 251 y 500 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 501 AND 1000 THEN 'Emite entre 501 y 1000 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 1001 AND 1667 THEN 'Emite entre 1001 y 1667 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 1668 AND 2500 THEN 'Emite entre 1668 y 2500 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 2501 AND 5000 THEN 'Emite entre 2501 y 5000 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 5001 AND 10000 THEN 'Emite entre 5001 y 10000 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 10001 AND 20000 THEN 'Emite entre 10001 y 20000 operaciones al mes'
WHEN T1.QPROMEDIO BETWEEN 20001 AND 40000 THEN 'Emite entre 20001 y 40000 operaciones al mes'
WHEN T1.QPROMEDIO > 40000 THEN 'Emite más de 40000 operaciones al mes'	
ELSE 'Revisar'
END AS Rango_Emision
FROM REGINISIS_PROMOPR T1
LEFT JOIN REGINISIS_GENERAL T2 ON T1.IREGISTRO=T2.IREGISTRO
WHERE  
T2.ITERCERO IS NOT NULL 
AND T2.ITERCERO NOT IN ('810000630','900100200')
)
SELECT *
FROM
(SELECT OPERACION,Rango_Emision,COUNT(Rango_Emision) AS TERCEROS,AVG(PROMEDIO) AS PROMEDIO_USO_MES
FROM X1
WHERE RANGO=1
AND OPERACION='ING5' --CAMBIAR TIPO DE OPERACIÓN SEGÚN NECESIDAD
GROUP BY OPERACION,Rango_Emision)
ORDER BY OPERACION,PROMEDIO_USO_MES DESC

--Query para calcular cantidad y % de uso de cierta operación respecto a cantidad diferente de terceros en la tabla de REGINISIS_PROMOPR
WITH X1 AS(
SELECT T1.ITDOPER AS ITDOPER,COUNT(DISTINCT T2.ITERCERO) AS QTercerosPorOper
FROM REGINISIS_PROMOPR T1
LEFT JOIN REGINISIS_GENERAL T2 ON T1.IREGISTRO=T2.IREGISTRO
WHERE T1.QPROMEDIO>=1
AND T2.FREGISTRO>='2024-01-01'
GROUP BY T1.ITDOPER)
, X2 AS (
SELECT COUNT(DISTINCT T2.ITERCERO) AS QTerceros
FROM REGINISIS_PROMOPR T1
LEFT JOIN REGINISIS_GENERAL T2 ON T1.IREGISTRO=T2.IREGISTRO
WHERE T2.FREGISTRO>='2024-01-01'
)
SELECT X1.ITDOPER,X1.QTercerosPorOper,X2.QTerceros,CAST(X1.QTercerosPorOper AS DECIMAL(10, 2)) / CAST(X2.QTerceros AS DECIMAL(10, 2)) AS PorcentajeTercerosCIE1
FROM X1,X2
ORDER BY X1.QTercerosPorOper DESC


'QUERY PARA ESTADÍSTICAS ESPECÍFICAS DE ACTUALIZACIONES'		

--Compilado máximo al cual ha llegado cada tercero
WITH T1 AS 
(
SELECT ITERCERO,
--FREGISTRO,
CASE 
WHEN CHAR_LENGTH(ICOMPILACION)=2 THEN IRELEASE||','||IACTUALIZACION||','||ICOMPILACION
ELSE IRELEASE||','||IACTUALIZACION||',0'||ICOMPILACION
END AS CONCATENADOA
FROM REGINISIS_MENSAJES T1
WHERE ICOMPILACION>=0 AND ITERCERO IS NOT NULL AND ITERCERO IS DISTINCT FROM ''
)
SELECT 
T1.ITERCERO
,MAX(T1.CONCATENADOA) AS CONCATENADOB
,T2.IEMPPROPIETARIO
FROM T1
LEFT JOIN TERCEROS T2 ON T1.ITERCERO=T2.ITERCERO
GROUP BY T1.ITERCERO,T2.IEMPPROPIETARIO
--HAVING MAX(CONCATENADOA)IN ('8,23,40','8,23,50','8,23,60')
ORDER BY MAX(T1.CONCATENADOA) DESC

--Cantidad de terceros que se encuentra en cada actualización y que tienen póliza vigente
WITH X1 AS(
SELECT ITERCERO, MAX(IRELEASE) AS RELE,MAX(IACTUALIZACION) AS ACTUALIZACION
FROM REGINISIS_MENSAJES 	
GROUP BY ITERCERO
ORDER BY ITERCERO ASC
)
SELECT RELE,ACTUALIZACION,COUNT(RELE||','||ACTUALIZACION)
FROM X1
GROUP BY RELE,ACTUALIZACION
ORDER BY RELE DESC,ACTUALIZACION DESC

--Actualizaciones por las cuales ha pasado un tercero
WITH T1 AS 
(SELECT ITERCERO, 
	CASE 
		WHEN CHAR_LENGTH(ICOMPILACION)=2 THEN IACTUALIZACION||','||ICOMPILACION
ELSE IACTUALIZACION||',0'||ICOMPILACION
	END AS CONCATENADOA
FROM REGINISIS_MENSAJES
--WHERE IRELEASE = 8 AND IACTUALIZACION>=19
)
SELECT DISTINCT ITERCERO,CONCATENADOA
FROM T1
WHERE ITERCERO IN ('900924666')
ORDER BY ITERCERO,CONCATENADOA desc

--Query para saber dónde están repartidos los terceros según la actualización máxima a la cual llegaron
-- OJO, SI EN ALGÚN MOMENTO HAY COMPILADOS DE TRES DÍGITOS LA CONSULTA SE DEBE REAJUSTAR EN (--A--)
WITH T1 AS 
(SELECT ITERCERO, 
	CASE 
		WHEN CHAR_LENGTH(ICOMPILACION)=2 THEN IACTUALIZACION||','||ICOMPILACION --(--A--)
ELSE IACTUALIZACION||',0'||ICOMPILACION
	END AS CONCATENADOA
FROM REGINISIS_MENSAJES
WHERE IRELEASE = 8 
)
SELECT CONCATENADOB,COUNT(CONCATENADOB)
FROM (SELECT ITERCERO,MAX(CONCATENADOA) AS CONCATENADOB
	  FROM T1
	  GROUP BY ITERCERO)
GROUP BY CONCATENADOB
ORDER BY CONCATENADOB DESC


'QUERY PARA GESTIONES ADMINISTRATIVAS ETE'
--'Parámetros para cálculo de tiempos'
--nombre de la tabla= PROC_TIEMPOSET(a,b,c)
-- a es 'at','ing'dependiendo de lo que se quiera calcular:
--'at' para calcular Tiempos objetivo + generales + tiempos AT (por especialista)
--'ing' para calcular Tiempos objetivo + generales + tiempos Ing (por ingeniero)
-- b es el mes para cálculo del indicador (numero del 1 al 12)
-- c es el año para cálculo del indicador (año en formato aaaa es decir 2024, etc)

--Tiempos objetivo + generales + tiempos AT (por especialista)	
SELECT *
FROM PROC_TIEMPOSET('at',:MESCIERRE,:ANIOCIERRE) 

--Zoom a TKs de AT por fuera de objetivos para un mes y año dados
SELECT
T1.ASIGNADOA,
T1.ITIQUETE,
AVG(T1.QMINATENCIONEMPRESA)/60.00 AS TA,
AVG(T1.QMINSOLUCIONEMPRESA)/60.00 AS TS,
T1.FHCIERRE
FROM SOP_TIQUETES T1
LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA = T7.ITITULO
LEFT JOIN ABADTIT T6 ON T6.ITABLA = 'ITDSOLICITUDC' AND T1.ITDSOLICITUD = T6.ITITULO
WHERE
T1.BANULADO = 'F'
AND EXTRACT(MONTH FROM T1.FHCIERRE) = :MES
AND EXTRACT(YEAR FROM T1.FHCIERRE) = :ANIO
AND T1.ASIGNADOA IN ('SALARCON', 'ACESPEDES', 'ATORO', 'AGIL', 'TLEON', 'VRESTREPO')
AND (T1.ITEMA IN ('AT-APO75', 'AT-CAP55', 'P-NP', 'AT-APO100', 'AT-APO105', 'AT-APO25', 'AT-APO45', 'AT-APO60', 'AT-APO95', 'AT-APO70', 'AT-APO65', 'AT-APO05', 'AT-APO35', 'AT-APO80', 'AT-APO90', 'AT-APO15', 'AT-APO40', 'AT-APO30', 'AT-APO50', 'AT-APO20', 'AT-APO120', 'AT-APO55', 'AT-APO85', 'AT-APO10') OR T1.ITEMA IS NULL)
AND (T7.NTITULO IN('1 - Atención sin novedades', '1 - Cliente no contesta', '1 - En pausa por el asesor', '1 - En pausa por el cliente', '1 - Escalado a AT', '1 - Escalado a Ing') OR T7.NTITULO IS NULL)
AND (T6.NTITULO IN ('1 - Consulta', '1 - Envío instructivo (con asistencia)', '1 - Falta de capacitación', '1 - Falta de recurso', '1 - ING Servicios otros', '1 - ING Servicios rep. BD', '1 - ING Servicios SQL', '1 - Intermitencia servidores InSoft', '1 - Novedad de configuración', '1 - PQR - Caso reasignado a otro Ingeniero', '1 - PQR - Error del sistema', '1 - PQR - Error del sistema (causa no identificada)', '1 - PQR - Error por cambio anterior (para uso AT e ING únicamente)', '1 - PQR - Error por caso nuevo (para uso AT e ING únicamente)', '1 - PQR - Error por normativa (para uso AT e ING únicamente)') OR T6.NTITULO IS NULL)
--AND T1.ITIQUETE NOT IN (1094695,1095002,1090419,1109577,1111844,1058040,1114476,1085483,1109712,1108677,1106529,1107956) -- SE VAN A IR SACANDO DEL CÁLCULO LOS TKS QUE POR ALGUNA RAZÓN NO SERÁN CONTADOS PARA TIEMPOS
AND T1.BEXCLUIRINFORMES IS NULL
AND T1.ITIQUETEBASE IS NULL
AND T1.ASIGNADOA<>T1.ABIERTOPOR
AND T1.FHSOLUCIONADO IS DISTINCT FROM T1.FHCIERRE
GROUP BY T1.ASIGNADOA,T1.ITIQUETE,T1.FHCIERRE
HAVING AVG(T1.QMINATENCIONEMPRESA)/60.00>5 OR AVG(T1.QMINSOLUCIONEMPRESA)/60.00 >18
ORDER BY T1.ASIGNADOA,AVG(T1.QMINSOLUCIONEMPRESA)/60.00 DESC
					
--Tiempos objetivo + generales + tiempos Ing (por ingeniero)
SELECT *
FROM PROC_TIEMPOSET('ing',:MESSOLUCION,:ANIOSOLUCION)		

--Zoom a PQRs de ING por fuera de objetivos para un mes y año dados
SELECT
T1.ASIGNADOA,
T1.ITIQUETE,
AVG(T1.QMINATENCIONEMPRESA)/60.00 AS TA,
AVG(T1.QMINSOLUCIONEMPRESA)/60.00 AS TS,
T1.FHSOLUCIONADO 
FROM SOP_TIQUETES T1
LEFT JOIN ABADTIT T6 ON T6.ITABLA = 'ITDSOLICITUDC' AND T1.ITDSOLICITUD = T6.ITITULO
WHERE
T1.BANULADO = 'F'
AND EXTRACT(MONTH FROM T1.FHSOLUCIONADO) = :MES --SE EVALÚA RESPECTO A MES DE SOLUCIÓN
AND EXTRACT(YEAR FROM T1.FHSOLUCIONADO) = :ANIO --SE EVALÚA RESPECTO A MES DE SOLUCIÓN
AND T1.ASIGNADOA IN ('ESUAREZ', 'DOCAMPO', 'PRENDON','DHURTADO','DRODRIGUEZ') --SOLO ASIGNADO A LOS ING SENIOR
AND T6.NTITULO NOT IN ('1 - ING Reunión ingeniería','1 - PQR Adición o mejora aprobada','1 - PQR Adición o mejora rechazada','1 - PQR - Adición o mejora rechazada','1 - PQR - Requerimiento técnico (para uso AT e ING únicamente)','1 - PQR - proyecto (para uso AT e ING únicamente)','1 - PQR Cambio normativo','1 - PQR - Adición o mejora aprobada','1 - PQR Ajuste del sistema') -- Se quitan los tipos de solicitud de cierre que NO aplican para tiempos
AND T1.IMOTIVO=0 --SOLO SE TIENEN EN CUENTA AMBIENTE DE PRODUCCIÓN
--AND T1.ITIQUETE NOT IN (303442,1071726,1094432,1103461,1109467,1067163,1076351,1105727,1106470,1110916) -- SE VAN A IR SACANDO DEL CÁLCULO LOS TKS QUE POR ALGUNA RAZÓN NO SERÁN CONTADOS PARA TIEMPOS
AND T1.BEXCLUIRINFORMES IS NULL
AND T1.ITEMA NOT IN ('ING-32') --Se suprimen los TKs de ADD-IN al ser internos
GROUP BY T1.ASIGNADOA,T1.ITIQUETE,T1.FHSOLUCIONADO 
HAVING AVG(T1.QMINATENCIONEMPRESA)/60.00>6 OR AVG(T1.QMINSOLUCIONEMPRESA)/60.00 >12
ORDER BY T1.ASIGNADOA,AVG(T1.QMINSOLUCIONEMPRESA)/60.00 DESC		

--Query para histórico de tiempos de ATE para un año dado (grupal)
SELECT
EXTRACT(MONTH FROM T1.FHCIERRE) AS MES,
EXTRACT(YEAR FROM T1.FHCIERRE) AS ANIO,
--T1.ASIGNADOA,
COUNT(T1.ITIQUETE),
AVG(T1.QMINATENCIONEMPRESA)/60.00 AS PROMEDIOATENCION,
CASE
WHEN AVG(T1.QMINATENCIONEMPRESA)/60.00 <=5 THEN 'En Objetivo'
ELSE 'Fuera de Objetivo'
END AS OBJETIVOTA,
AVG(T1.QMINSOLUCIONEMPRESA)/60.00 AS PROMEDIOSOLUCION,
CASE
WHEN AVG(T1.QMINSOLUCIONEMPRESA)/60.00 <=18 THEN 'En Objetivo'
ELSE 'Fuera de Objetivo'
END AS OBJETIVOTS
FROM SOP_TIQUETES T1
LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA = T7.ITITULO
LEFT JOIN ABADTIT T6 ON T6.ITABLA = 'ITDSOLICITUDC' AND T1.ITDSOLICITUD = T6.ITITULO
WHERE
T1.BANULADO = 'F'
AND EXTRACT(YEAR FROM T1.FHCIERRE) = :ANIO
AND T1.ASIGNADOA IN ('SALARCON', 'ACESPEDES', 'ATORO', 'AGIL', 'TLEON', 'VRESTREPO')
AND T1.ITEMA IN ('AT-APO75', 'AT-CAP55', 'P-NP', 'AT-APO100', 'AT-APO105', 'AT-APO25', 'AT-APO45', 'AT-APO60', 'AT-APO95', 'AT-APO70', 'AT-APO65', 'AT-APO05', 'AT-APO35', 'AT-APO80', 'AT-APO90', 'AT-APO15', 'AT-APO40', 'AT-APO30', 'AT-APO50', 'AT-APO20', 'AT-APO120', 'AT-APO55', 'AT-APO85', 'AT-APO10')
AND T7.NTITULO IN('','1 - Atención sin novedades', '1 - Cliente no contesta', '1 - En pausa por el asesor', '1 - En pausa por el cliente', '1 - Escalado a AT', '1 - Escalado a Ing')
AND T6.NTITULO IN ('','1 - Consulta', '1 - Envío instructivo (con asistencia)', '1 - Falta de capacitación', '1 - Falta de recurso', '1 - ING Servicios otros', '1 - ING Servicios rep. BD', '1 - ING Servicios SQL', '1 - Intermitencia servidores InSoft', '1 - Novedad de configuración', '1 - PQR - Caso reasignado a otro Ingeniero', '1 - PQR - Error del sistema', '1 - PQR - Error del sistema (causa no identificada)', '1 - PQR - Error por cambio anterior (para uso AT e ING únicamente)', '1 - PQR - Error por caso nuevo (para uso AT e ING únicamente)', '1 - PQR - Error por normativa (para uso AT e ING únicamente)')
--AND T1.ITIQUETE NOT IN (1094695,1095002,1090419,1109577,1111844,1058040,1114476,1085483,1109712,1108677,1106529,1107956) -- SE VAN A IR SACANDO DEL CÁLCULO LOS TKS QUE POR ALGUNA RAZÓN NO SERÁN CONTADOS PARA TIEMPOS
AND T1.ITIQUETEBASE IS NULL
AND T1.ASIGNADOA<>T1.ABIERTOPOR
AND T1.BEXCLUIRINFORMES IS NULL
AND T1.FHSOLUCIONADO IS DISTINCT FROM T1.FHCIERRE
GROUP BY EXTRACT(YEAR FROM T1.FHCIERRE), EXTRACT(MONTH FROM T1.FHCIERRE)
ORDER BY EXTRACT(YEAR FROM T1.FHCIERRE), EXTRACT(MONTH FROM T1.FHCIERRE)

--Query para histórico de tiempos de ATE para un año dado (Individual)
SELECT
EXTRACT(MONTH FROM T1.FHCIERRE) AS MES,
EXTRACT(YEAR FROM T1.FHCIERRE) AS ANIO,
T1.ASIGNADOA,
COUNT(T1.ITIQUETE),
AVG(T1.QMINATENCIONEMPRESA)/60.00 AS PROMEDIOATENCION,
CASE
WHEN AVG(T1.QMINATENCIONEMPRESA)/60.00 <=5 THEN 'En Objetivo'
ELSE 'Fuera de Objetivo'
END AS OBJETIVOTA,
AVG(T1.QMINSOLUCIONEMPRESA)/60.00 AS PROMEDIOSOLUCION,
CASE
WHEN AVG(T1.QMINSOLUCIONEMPRESA)/60.00 <=18 THEN 'En Objetivo'
ELSE 'Fuera de Objetivo'
END AS OBJETIVOTS
FROM SOP_TIQUETES T1
LEFT JOIN ABADTIT T7 ON T7.ITABLA = 'ESTADOAPERTURA' AND T1.ITDESTADOAPERTURA = T7.ITITULO
LEFT JOIN ABADTIT T6 ON T6.ITABLA = 'ITDSOLICITUDC' AND T1.ITDSOLICITUD = T6.ITITULO
WHERE
T1.BANULADO = 'F'
AND EXTRACT(YEAR FROM T1.FHCIERRE) = :ANIO
AND T1.ASIGNADOA IN ('SALARCON', 'ACESPEDES', 'ATORO', 'AGIL', 'TLEON', 'VRESTREPO')
AND T1.ITEMA IN ('AT-APO75', 'AT-CAP55', 'P-NP', 'AT-APO100', 'AT-APO105', 'AT-APO25', 'AT-APO45', 'AT-APO60', 'AT-APO95', 'AT-APO70', 'AT-APO65', 'AT-APO05', 'AT-APO35', 'AT-APO80', 'AT-APO90', 'AT-APO15', 'AT-APO40', 'AT-APO30', 'AT-APO50', 'AT-APO20', 'AT-APO120', 'AT-APO55', 'AT-APO85', 'AT-APO10')
AND T7.NTITULO IN('','1 - Atención sin novedades', '1 - Cliente no contesta', '1 - En pausa por el asesor', '1 - En pausa por el cliente', '1 - Escalado a AT', '1 - Escalado a Ing')
AND T6.NTITULO IN ('','1 - Consulta', '1 - Envío instructivo (con asistencia)', '1 - Falta de capacitación', '1 - Falta de recurso', '1 - ING Servicios otros', '1 - ING Servicios rep. BD', '1 - ING Servicios SQL', '1 - Intermitencia servidores InSoft', '1 - Novedad de configuración', '1 - PQR - Caso reasignado a otro Ingeniero', '1 - PQR - Error del sistema', '1 - PQR - Error del sistema (causa no identificada)', '1 - PQR - Error por cambio anterior (para uso AT e ING únicamente)', '1 - PQR - Error por caso nuevo (para uso AT e ING únicamente)', '1 - PQR - Error por normativa (para uso AT e ING únicamente)')
--AND T1.ITIQUETE NOT IN (1094695,1095002,1090419,1109577,1111844,1058040,1114476,1085483,1109712,1108677,1106529,1107956) -- SE VAN A IR SACANDO DEL CÁLCULO LOS TKS QUE POR ALGUNA RAZÓN NO SERÁN CONTADOS PARA TIEMPOS
AND T1.ITIQUETEBASE IS NULL
AND T1.ASIGNADOA<>T1.ABIERTOPOR
AND T1.BEXCLUIRINFORMES IS NULL
AND T1.FHSOLUCIONADO IS DISTINCT FROM T1.FHCIERRE
GROUP BY T1.ASIGNADOA, EXTRACT(YEAR FROM T1.FHCIERRE), EXTRACT(MONTH FROM T1.FHCIERRE)
ORDER BY T1.ASIGNADOA, EXTRACT(YEAR FROM T1.FHCIERRE), EXTRACT(MONTH FROM T1.FHCIERRE)
       
--Query para TKs pendientes de Ing Senior
SELECT
T1.ITIQUETE
,T3.NTEMA
,T1.ABIERTOPOR
,REPLACE(CAST((LOCALTIMESTAMP - T1.FHAPERTURA) AS DECIMAL (10,2)),'.',',') AS DIAS_DESDE_APERTURA
,T5.NTITULO AS TIPO_SOLICITUD_APERTURA
,T1.ASIGNADOA
FROM SOP_TIQUETES T1
LEFT JOIN ABADTIT T5 ON T5.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T5.ITITULO
LEFT JOIN SOP_TEMAS T3 ON T1.ITEMA=T3.ITEMA
WHERE 
T1. ASIGNADOA IN ('PRENDON','ESUAREZ','DOCAMPO','DHURTADO','DRODRIGUEZ') 
AND T1.BANULADO='F' 
AND T1.FHSOLUCIONADO IS NULL 
AND T5.NTITULO IS NOT NULL 
AND T5.NTITULO IN ('1 - PQR Error del sistema','1 - Consulta','1 - ING Servicios BD','1 - ING Servicios Otros','1 - ING Servicios SQL','1 - PQR Error/Novedad externa','1 - PQR Ajuste del sistema')
AND T1.FCREACION<CURRENT_DATE
AND T1.ITIQUETE NOT IN (623139) 
AND T1.IAPLICACION NOT IN ('CL')
--AND T1.ITIQUETE IN (1218434)
ORDER BY T1.ASIGNADOA, T5.NTITULO

--Para enviar a AT u Ops los TKs pendientes por cerrar de Ing Senior
SELECT 
T1.ITIQUETE,
T1.ABIERTOPOR,
T1.ASIGNADOA   
FROM SOP_TIQUETES T1
LEFT JOIN SOP_BITACORA T2 ON T1.ITIQUETE=T2.ITIQUETE
WHERE 
T1.BANULADO='F'
AND T1.ASIGNADOA IN ('DOCAMPO','PRENDON','ESUAREZ','DHURTADO') 
AND T1.FHCIERRE IS NULL 
AND T1.FHSOLUCIONADO IS NOT NULL 
AND T1.IACTUALIZACION>=:ACT --NÚMERO DE ÚLTIMA ACTUALIZACIÓN LIBERADA A PROD
--AND T2.ICOMPILADO <= :COMPILADOCLIENTES --ÚLTIMO COMPILADO LIBERADO A PROD
ORDER BY T1.ABIERTOPOR	

--Query para sacar los PQRs cerrados en un mes y año dado para calcular comisiones Ing Senior 
--(cuyo tipo de solicitud de apertura cuente para comisiones)
SELECT * 
FROM
(SELECT
T1.ITIQUETE AS Tiquete,
T1.IAPLICACION,
TRIM(
CASE
	WHEN T5.NTITULO='1 - PQR mejora' AND T6.NTITULO='1 - PQR - Adición o mejora aprobada' THEN 'Mejora'
WHEN T5.NTITULO='1 - PQR Cambio normativo' AND T6.NTITULO='1 - PQR Cambio normativo' THEN 'Cambio normativo'
WHEN T5.NTITULO='1 - Requerimiento técnico (para uso AT e ING únicamente)' AND T6.NTITULO='1 - PQR - Requerimiento técnico (para uso AT e ING únicamente)' THEN 'Requerimiento técnico'
WHEN T5.NTITULO='1 - PQR proyecto (para uso AT e ING únicamente)' AND T6.NTITULO='1 - PQR - proyecto (para uso AT e ING únicamente)' THEN 'Proyecto'
WHEN T5.NTITULO='1 - PQR Ajuste del sistema' AND T6.NTITULO='1 - PQR Ajuste del sistema' THEN 'Ajuste'
WHEN T6.NTITULO IN ('1 - PQR - Adición o mejora aprobada','1 - PQR Cambio normativo','1 - PQR - Requerimiento técnico (para uso AT e ING únicamente)','1 - PQR - proyecto (para uso AT e ING únicamente)','1 - PQR Ajuste del sistema') THEN 'Para revisar'
ELSE 'No tener en cuenta'
END) AS TIPO,
T1.QDEDICACION AS MinutosDedicacion,
--CAST(T1.FHCIERRE AS DATE) AS FECHACIERRE,
T1.ASIGNADOA,
T5.NTITULO AS TipoSolicitudApertura, -- Sale de tabla ABADTIT T5
T6.NTITULO AS TipoSolicitudCierre, -- Sale de tabla ABADTIT T6
T1.FHCIERRE
FROM SOP_TIQUETES T1
LEFT JOIN ABADTIT T5 ON T5.ITABLA='ITDSOLICITUD' AND T1.ITDSOLICITUDA=T5.ITITULO
LEFT JOIN ABADTIT T6 ON T6.ITABLA='ITDSOLICITUDC' AND T1.ITDSOLICITUD=T6.ITITULO
WHERE 
T1.ASIGNADOA IN ('DOCAMPO','ESUAREZ','PRENDON') 
AND EXTRACT(MONTH FROM T1.FHCIERRE)=:MES 
AND EXTRACT(YEAR FROM T1.FHCIERRE)=:ANIO
AND T1.BANULADO='F'
) 
WHERE TIPO <>'No tener en cuenta'
ORDER BY ASIGNADOA ASC,TIPO 

--Para sacar qué temas tienen asignados los especialistas o ing
SELECT T1.IPERFIL,
trim(CASE
	WHEN T1.IPERFIL='INS_ATE_A01' THEN 'ATORO'
WHEN T1.IPERFIL='INS_ATE_A02' THEN 'ACESPEDES'
WHEN T1.IPERFIL='INS_ATE_A03' THEN 'VRESTREPO'
WHEN T1.IPERFIL='INS_ATE_A04'THEN 'SIN ASIGNAR'
WHEN T1.IPERFIL='INS_ATE_A05' THEN 'DCEBALLOS'
WHEN T1.IPERFIL='INS_ATE_A06' THEN 'SALARCON'
WHEN T1.IPERFIL='INS_ATE_A07' THEN 'LGIRALDO'
WHEN T1.IPERFIL='INS_ATE_A08' THEN 'AGIL'
WHEN T1.IPERFIL='INS_ATE_A09' THEN 'TLEON'
WHEN T1.IPERFIL='INS_ING_ESU' THEN 'ESUAREZ'
WHEN T1.IPERFIL='INS_ING_DOC' THEN 'DOCAMPO'
WHEN T1.IPERFIL='INS_ING_PRE' THEN 'PRENDON'
WHEN T1.IPERFIL='INS_ING_DHU' THEN 'DHURTADO'
ELSE 'Revisar'
END) AS ASIGNADOA,
T1.ITEMA,T2.NTEMA,T2.NCATEGORIA 
FROM SOP_PERFILESPORTEMA T1
LEFT JOIN SOP_TEMAS T2 ON T1.ITEMA=T2.ITEMA
WHERE 
IPERFIL IN ('INS_ATE_A01','INS_ATE_A02','INS_ATE_A03','INS_ATE_A04','INS_ATE_A05','INS_ATE_A06','INS_ATE_A07','INS_ATE_A08','INS_ATE_A09','INS_ING_ESU','INS_ING_DOC','INS_ING_PRE','INS_ING_DHU')
AND T1.FHFINAL >= LOCALTIMESTAMP 
ORDER BY IPERFIL ASC

'QUERY PARA FASE 1'

--Sacar PQRs Fase 1	
SELECT 
T1.ITIQUETE,
REPLACE(COALESCE(T3.ASUNTO,T2.ASUNTO),'Descripción:','') AS ASUNTO,
--T1.IACTUALIZACION||','||T1.ICOMPILADO,
T1.REPORTADOPOR AS REPORTADOPOR,
TRIM(
CASE 
WHEN T1.TIPO='4' THEN'Error'
WHEN T1.TIPO='3' THEN'Adición'
WHEN T1.TIPO='2' THEN'Mejora'
WHEN T1.TIPO='1' THEN'Error'
WHEN T1.TIPO='' THEN'Faltó Tipo PQR'
ELSE'REVISAR'
END) AS TIPODEPQR,
TRIM(
CASE
WHEN T2.IMOTIVO=1 THEN'Pruebas'
WHEN T2.IMOTIVO=0 THEN'Produccion'
WHEN T2.IMOTIVO IS NULL THEN'Sin ambiente'
ELSE'Revisar'
END) AS AMBIENTE,
TRIM(
CASE 
WHEN T1.IPRIORIDAD=4 THEN'Máxima'
WHEN T1.IPRIORIDAD=3 THEN'Alta'
WHEN T1.IPRIORIDAD=2 THEN'Normal'
WHEN T1.IPRIORIDAD=1 THEN'Baja'
ELSE'Sin prioridad'
END) AS PRIORIDAD,
'No probado' AS ESTADO,
'Falta crear TK' AS OBSERVACIONES,
T1.SOLUCIONADOPOR,
T2.FHSOLUCIONADO,
T1.BACTAUTOCOMPLETA,
T1.IACTUALIZACION,
T1.ICOMPILADO
--,T2.FHSOLUCIONADO --Para validar que filtros estén correctos. Usar según necesidad
FROM SOP_BITACORA T1
LEFT JOIN SOP_TIQUETES T2 ON T1.ITIQUETE=T2.ITIQUETE
LEFT JOIN SOP_TIQUETES T3 ON T2.ITIQUETEREF=T3.ITIQUETE
WHERE 
T1.IAPLICACION NOT IN ('UT','CL','PW','CA','a','SV')
--R8.25.17 Desarrollo
AND T2.FHSOLUCIONADO>='2025-04-28 11:00'
--AND T1.IACTUALIZACION IN (23,24)
--AND T1.ICOMPILADO IN (11)
AND T1.ITIQUETE NOT IN (1277782,1252392,1260754,1263258,1263275,1268248,1269730,1269734,303069,302748,302775,302874,302902,303073,303083,303108,1259371,1261758,1273174,1284248,1252310,1261951,1267569,1248090,1253641,1257461,1257927,1258024,1260978,1081791,1262631,1262757,1264792,1269767,303164,1267153,1281874,1258383,1273200,1274495,1275261,1275276,1281255,1144975,1277753,1278429,1248083,1282693,1283327,1281496,1261842,1263123,1274287,1259450,1255577,1285577,1282702,1281310,303167,1232769,1262043,1261127,1265767,1215847,1254749,1255005,1255796,1257708,1259563,1260094,1261239,1262125,1262331,1262635,1250800,1277840,1264360,1265999,1266007,1278473,1268504,1271043,1275348,1279933,1281699,1283059,1281322,1286039,1258995,1284461,1254274,1271389,1228863,1229079,1249758,1253768,1253781,1254130,1254231,1256215,1256341,1262121,1262149,1262537,1262548,1262555,1262664,1264736,1264952,1264993,1265008,1265215,1266077,1266110,1266223,1268926,1270214,1270240,1271124,1271133,1271162,1253945,1271668,1264802,1270642,1261482,1269109,1264849,1271534,1272646,1272998,1273032,1273109,1274596,1271197,1274527,1272339,1273816,1274570,1275055,1275775,1275829,1275070,1274616,1276071,1261826,1263120,1265002,1276038,1276058,1276862,1278720,303314,1254343,1255957,1256576,1273639,1259072,1260242,1276657,1273719,1261804,1263313,1264384,1268954,1266889,1267150,1080127,1268274,1258021,1269645,1271206,1272630,1274174,1272890,1265271,1268146,1270175,1276112,1279211,1279727,1280894,1280938,1281208,1279959,1281530,1264619,1266798,1259645,1282701,1282254,1282679,1288805,1289075,1281678,1260931,1286070,1286188,1286051,1273808,1285295,1285329,1286069,1280986,1286763,1286083,1286481,1251477,1287391,1281230,1285373,1287307,1283270,1285362,1271171,1287252,1287912,1288555,1285641,1289487,1145005,1286885,1288909,1290857,1289502,1286490,1289675,1282367,1289793,1288982,1289777,1261475,1291477,1289722,1289218,1290055,1284993,1288268,1288314,1291842,1285830,1289654,1289674,1263581,1288191,1291838,1291286,1291534,1291785,1291824,1292125,1291662,1292862,1292792,1293919,1296142,1293756,1294218,1293730,1295599,1293455,1293912,1275077,1294451,1294673,1294539,1293985,1246068,1294252,1294445,1294795,1272959,1296117,1295147,1294578,1295803,1295909,1296558,1294707,1295091,1296080,1296149,1297036,1296597,1296904,1293251,1293260)	
-- Fin
--R8.25.12 Clientes
--AND T2.FHSOLUCIONADO>='2025-06-04'
--AND T1.ICOMPILADO IN (11,12,13)
--AND T1.ITIQUETE NOT IN (1269730,1269734,1273200,1277753,1281255,1274287,1275077,1273174,1277840,1278473,1275348,1271668,1281208,1282254,1282679,1282701)
-- Fin
AND T2.ASIGNADOA IN ('DOCAMPO','ESUAREZ','DHURTADO','PRENDON','DRODRIGUEZ')
AND T2.ITEMA NOT IN ('ING-32','ING-26') --Se omite tema de AddIn a partir del 19/11/2024 y tema de sistema clientes desde 04/12/2024
AND T2.ITDSOLUCION IS DISTINCT FROM 009 --Se omiten PQRs cuyo tipo de solución sea Con despliegue de servicio
ORDER BY T1.REPORTADOPOR


SELECT ITIQUETE,ASIGNADOA
FROM SOP_TIQUETES
LEFT JOIN SOP_TEMAS ON SOP_TIQUETES.ITEMA=SOP_TEMAS.ITEMA
WHERE FHSOLUCIONADO=FHCIERRE AND ASIGNADOA IN ('SALARCON','AGIL','ACESPEDES','TLEON','ATORO','EDUQUE','SCALLE','JCASTILLO','VRESTREPO') AND NTEMA NOT LIKE '%pruebas%'
ORDER BY ITIQUETE DESC








